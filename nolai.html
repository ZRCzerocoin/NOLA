<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NOLA Metrics — Sanbase & Coingecko</title>
<!-- config.js must define:
     const SANBASE = "";
     const COINGECKO = "";
     window.SANBASE = SANBASE;
     window.COINGECKO = COINGECKO;
-->
<script src="config.js"></script>
<link rel="icon" href="/Link/logo.gif" />
<style>
  :root{
    --bg1:#070518; --bg2:#0f0a22;
    --card-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    --glass-border: rgba(255,255,255,0.04);
    --accent-purple:#8a5cff; --accent-blue:#2ea0ff;
    --muted:#9fb0c6; --good:#40d47e; --bad:#ff6b6b;
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#eaf2ff}
  header{
    height:72px;display:flex;align-items:center;gap:12px;padding:12px 20px;
    background:linear-gradient(90deg, rgba(138,92,255,0.12), rgba(46,160,255,0.06));
    backdrop-filter: blur(6px); border-bottom:1px solid rgba(255,255,255,0.03);
    position:sticky; top:0; z-index:90;
  }
  header img{width:44px;height:44px;border-radius:50%;object-fit:cover;box-shadow:0 12px 36px rgba(0,0,0,0.6)}
  .title{display:flex;flex-direction:column}
  .title h1{margin:0;font-size:18px}
  .title .sub{font-size:12px;color:var(--muted)}

  #wrap{display:flex;gap:18px;padding:18px;height:calc(100vh - 72px)}
  aside{width:320px;padding:16px;border-radius:var(--radius);background:var(--card-bg);border:1px solid var(--glass-border);backdrop-filter:blur(6px)}
  main{flex:1;overflow:auto;padding:6px 2px;display:flex;flex-direction:column;gap:14px}

  .brand{display:flex;gap:12px;align-items:center}
  .small{font-size:12px;color:var(--muted)}
  .meta{font-size:13px;color:var(--muted);margin-top:10px}

  .price-strip{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .price-card{flex:1;min-width:140px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--glass-border)}
  .price-card .label{font-size:12px;color:var(--muted)}
  .price-card .value{font-weight:800;font-size:18px;margin-top:6px}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
  .card{background:var(--card-bg);border-radius:12px;padding:14px;border:1px solid var(--glass-border);box-shadow:0 12px 36px rgba(2,6,23,0.5)}
  .card h3{margin:0;font-size:15px}
  .card .small{margin-top:8px;color:var(--muted)}

  canvas.spark{width:100%;height:48px;display:block;border-radius:6px}

  /* NOL AI */
  .nola-ai{margin-top:18px;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(138,92,255,0.04), rgba(46,160,255,0.02));border:1px solid var(--glass-border);display:flex;flex-direction:column;align-items:center;gap:10px}
  .robot{width:110px;height:110px}
  .soon{text-transform:uppercase;font-weight:900;background:linear-gradient(90deg,var(--accent-purple),var(--accent-blue));-webkit-background-clip:text;color:transparent}

  footer{padding:10px;text-align:center;color:var(--muted);border-top:1px solid rgba(255,255,255,0.02)}

  /* small animations */
  @keyframes eyeWander {0%{transform:translate(0,0)}20%{transform:translate(4px,-2px)}40%{transform:translate(-3px,3px)}60%{transform:translate(5px,2px)}80%{transform:translate(-2px,-3px)}100%{transform:translate(0,0)}}
  @keyframes bob {0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
  .nola-ai .head{animation:bob 4s ease-in-out infinite}
  .nola-ai .eye{animation:eyeWander 5s cubic-bezier(.45,.05,.55,.95) infinite;transform-origin:50% 50%}

  @media (max-width:1000px){#wrap{flex-direction:column}aside{width:auto}}
</style>
</head>
<body>
  <header>
    <img src="/Link/logo.gif" alt="logo" />
    <div class="title">
      <h1>NOLA Metrics</h1>
      <div class="sub small">Sanbase hourly • Coingecko 20s • LocalStorage cache</div>
    </div>
  </header>

  <div id="wrap">
    <aside>
      <div class="brand">
        <div style="flex:1">
          <div style="font-weight:800">NOLA Metrics</div>
          <div class="small">Sanbase + Coingecko tool</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="font-size:13px;color:var(--muted)">API Budget</div>
        <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
          <div style="font-weight:800;font-size:18px" id="budget-left">—</div>
          <div class="small">calls left (monthly)</div>
        </div>
        <div class="meta small" id="last-fetch">Last Sanbase update: —</div>
      </div>

      <div style="margin-top:14px">
        <div style="font-size:13px;color:var(--muted);margin-bottom:8px">Quick prices</div>
        <div class="price-strip" id="price-strip"></div>
      </div>

      <div class="nola-ai" aria-hidden="true">
        <div class="robot">
          <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:100%;">
            <defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#8a5cff"/><stop offset="1" stop-color="#2ea0ff"/></linearGradient></defs>
            <g class="head">
              <rect x="12" y="18" rx="12" ry="12" width="96" height="72" fill="url(#g1)" opacity="0.14"/>
              <rect x="22" y="28" rx="8" ry="8" width="76" height="52" fill="#0b0b12" stroke="rgba(255,255,255,0.06)"/>
              <g class="eye">
                <circle cx="44" cy="52" r="6" fill="#fff"/><circle cx="76" cy="52" r="6" fill="#fff"/>
                <circle cx="44" cy="52" r="3" fill="#0b0720"/><circle cx="76" cy="52" r="3" fill="#0b0720"/>
              </g>
              <rect x="46" y="76" width="28" height="6" rx="3" fill="rgba(255,255,255,0.04)"/>
            </g>
          </svg>
        </div>
        <div class="soon">SOON</div>
      </div>

      <div class="meta small" style="margin-top:12px">
        Sanbase: <strong id="san-status">—</strong><br/>
        Coingecko: <strong id="cg-status">—</strong>
        <div style="margin-top:6px">Shared global cache requires server-side (Cloudflare Worker). This page uses localStorage only.</div>
      </div>
    </aside>

    <main>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">Dashboard</div>
        <div class="small" id="update-msg">Initializing…</div>
      </div>

      <div id="coins-prices" class="grid"></div>

      <div class="grid" id="metrics-grid"></div>

    </main>
  </div>

  <footer>
    NOLA © All Rights Reserved — <a href="https://nol.pages.dev" target="_blank" style="color:var(--accent-blue)">Website</a> | Support: support@nola.work.gd
  </footer>

<script>
/* ================== Config & State ================== */
const SANBASE_KEY = window.SANBASE || '';      // from config.js
const COINGECKO_KEY = window.COINGECKO || '';  // from config.js (Coingecko API key optional)
const SANBASE_GRAPHQL = 'https://api.santiment.net/graphql';
const COINGECKO_REST = 'https://api.coingecko.com/api/v3/simple/price';
const MONTHLY_LIMIT = 1000;
const BUDGET_KEY = 'NOLA_SAN_BUDGET_V2';
const CACHE_KEY = 'NOLA_SAN_CACHE_V2';
const COINS = [
  { slug:'bitcoin', ticker:'BTC', cg_id:'bitcoin' },
  { slug:'ethereum', ticker:'ETH', cg_id:'ethereum' },
  { slug:'polygon', ticker:'MATIC', cg_id:'polygon' },
  { slug:'solana', ticker:'SOL', cg_id:'solana' },
  { slug:'binancecoin', ticker:'BNB', cg_id:'binancecoin' }
];
const TTL = { sanbase: 60*60*1000, // 1 hour
              coingecko: 20*1000 } // 20 seconds

/* ============== Helpers ============== */
const $ = id => document.getElementById(id);
const nowTs = () => Date.now();
const log = (...a)=>console.debug('[NOLA]',...a);
const err = (...a)=>console.error('[NOLA]',...a);

/* ============== Budget helpers ============== */
function loadBudget(){
  try{
    const raw = localStorage.getItem(BUDGET_KEY);
    if(!raw){ const b={firstTs: nowTs(), used:0}; localStorage.setItem(BUDGET_KEY, JSON.stringify(b)); return b; }
    const b = JSON.parse(raw);
    if(nowTs() - b.firstTs > 30*24*60*60*1000){ const nb={firstTs: nowTs(), used:0}; localStorage.setItem(BUDGET_KEY, JSON.stringify(nb)); return nb; }
    return b;
  }catch(e){ const b={firstTs: nowTs(), used:0}; localStorage.setItem(BUDGET_KEY, JSON.stringify(b)); return b; }
}
function canRequest(){ return loadBudget().used < MONTHLY_LIMIT; }
function recordRequest(){ const b = loadBudget(); b.used = (b.used||0)+1; localStorage.setItem(BUDGET_KEY, JSON.stringify(b)); renderBudget(); }
function renderBudget(){ const b = loadBudget(); $('budget-left').textContent = Math.max(0, MONTHLY_LIMIT - (b.used||0)); $('last-fetch').textContent = 'since ' + new Date(b.firstTs).toLocaleString(); }

/* ============== Cache helpers ============== */
function loadCache(){ try{ const raw = localStorage.getItem(CACHE_KEY); return raw ? JSON.parse(raw) : {meta:{}}; }catch(e){ return {meta:{}}; } }
function saveCache(obj){ localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); }
function getCached(slug, key){
  const cache = loadCache();
  if(!cache[slug] || !cache[slug][key]) return null;
  const item = cache[slug][key];
  if(nowTs() - (item.ts || 0) > (key === 'sanbase' ? TTL.sanbase : TTL.coingecko)) return null;
  return item.value;
}
function setCached(slug, key, value){
  const cache = loadCache();
  cache[slug] = cache[slug] || {};
  cache[slug][key] = {ts: nowTs(), value};
  saveCache(cache);
}

/* ============== Sanbase GraphQL helper ============== */
async function querySanbase gql(q) {
  // wrapper; accepts GraphQL query string q
  if(!SANBASE_KEY){ throw new Error('SANBASE_KEY_MISSING'); }
  if(!canRequest()){ log('sanbase budget exhausted'); return null; }
  try{
    const res = await fetch(SANBASE_GRAPHQL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization':'Apikey ' + SANBASE_KEY },
      body: JSON.stringify({ query: q })
    });
    recordRequest();
    if(!res.ok){ const txt = await res.text(); throw new Error('Sanbase error ' + res.status + ' ' + txt); }
    const json = await res.json();
    if(json.errors) throw new Error('Sanbase errors: ' + JSON.stringify(json.errors));
    return json.data;
  }catch(e){ err('Sanbase query failed', e); return null; }
}

/* ===== Build Sanbase queries (best-effort lightweight) ===== */
function buildSanbaseMetricQuery(slug){
  // We'll request social_volume (7d) and dev_activity (30d) as separate calls are safer.
  return `
  {
    socialVolume: getMetric(metric: "social_volume") {
      timeseriesData(slug: "${slug}", from: "utc_now-7d", to: "utc_now", interval: "6h") { datetime value }
    }
    devActivity: getMetric(metric: "dev_activity") {
      timeseriesData(slug: "${slug}", from: "utc_now-30d", to: "utc_now", interval: "1d") { datetime value }
    }
  }`;
}

/* ============== Coingecko fetch helper ============== */
async function fetchCoingecko(ids){
  // ids: array of coingecko ids or a comma string
  try{
    const idsParam = Array.isArray(ids) ? ids.join(',') : ids;
    const url = `${COINGECKO_REST}?ids=${encodeURIComponent(idsParam)}&vs_currencies=usd&include_24hr_change=true&include_24hr_vol=true`;
    // Coingecko usually doesn't require an API key; if provided we won't use it in this call (their free endpoints don't accept key param)
    const res = await fetch(url);
    if(!res.ok){ err('Coingecko status', res.status); return null; }
    const json = await res.json();
    return json;
  }catch(e){ err('Coingecko fetch failed', e); return null; }
}

/* ============== Sparkline drawing ============== */
function drawSpark(canvas, arr){
  if(!canvas || !arr || !arr.length) return;
  try{
    const ctx = canvas.getContext('2d');
    const dpr = devicePixelRatio || 1;
    const w = canvas.clientWidth * dpr;
    const h = canvas.clientHeight * dpr;
    canvas.width = w; canvas.height = h;
    ctx.clearRect(0,0,w,h);
    const vals = arr.map(p => +p.value);
    const min = Math.min(...vals), max = Math.max(...vals);
    ctx.beginPath();
    vals.forEach((v,i) => {
      const x = (i/(vals.length-1))*w;
      const y = h - ((v - min)/(max - min || 1))*h;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.strokeStyle = 'rgba(46,160,255,0.95)';
    ctx.lineWidth = Math.max(1, 1.5 * dpr);
    ctx.stroke();
    ctx.lineTo(w,h); ctx.lineTo(0,h); ctx.closePath();
    ctx.fillStyle = 'rgba(138,92,255,0.06)';
    ctx.fill();
  }catch(e){ console.warn('spark error',e); }
}

/* ============== Rendering functions ============== */
function renderBudget(){ renderBudgetUI(); }
function renderBudgetUI(){
  const b = loadBudget();
  $('budget-left').textContent = Math.max(0, MONTHLY_LIMIT - (b.used||0));
  $('last-fetch').textContent = 'since ' + new Date(b.firstTs).toLocaleString();
}
function setStatus(msg){ $('update-msg').textContent = msg; }

/* Render price strip & cards from cache */
function renderFromCache(){
  // Price strip
  const strip = $('price-strip'); strip.innerHTML = '';
  // coins-prices main
  const cp = $('coins-prices'); cp.innerHTML = '';
  const mg = $('metrics-grid'); mg.innerHTML = '';

  const coingeckoCached = getCached('coingecko','all'); // we'll store all coingecko data as 'all'

  for(const c of COINS){
    const priceObj = coingeckoCached && coingeckoCached[c.cg_id] ? coingeckoCached[c.cg_id] : null;
    // price strip
    const pcard = document.createElement('div'); pcard.className = 'price-card';
    pcard.innerHTML = `<div class="label">${c.ticker}</div><div class="value">${priceObj ? ('$'+Number(priceObj.usd).toLocaleString()) : '—'}</div>`;
    strip.appendChild(pcard);

    // main price card with spark placeholder
    const card = document.createElement('div'); card.className = 'card';
    card.innerHTML = `<h3>${c.ticker}</h3>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div>
          <div class="small">Price</div>
          <div style="font-weight:800;font-size:18px">${priceObj ? ('$'+Number(priceObj.usd).toLocaleString()) : '—'}</div>
          <div class="small">${priceObj && priceObj.usd_24h_change ? (priceObj.usd_24h_change>=0?'+':'')+Number(priceObj.usd_24h_change).toFixed(2)+'% (24h)' : ''}</div>
          <div class="small">Vol 24h: ${priceObj && priceObj.usd_24h_vol ? Number(priceObj.usd_24h_vol).toLocaleString() : '—'}</div>
        </div>
        <div style="width:50%;padding-left:12px">
          <canvas class="spark" id="spark-${c.cg_id}"></canvas>
        </div>
      </div>
      <div class="small" style="margin-top:10px">Sanbase: ${getCached(c.slug,'sanbase') ? 'cached' : 'stale'}</div>`;
    cp.appendChild(card);

    // metrics smaller card
    const metricCard = document.createElement('div'); metricCard.className = 'card';
    const social = getCached(c.slug,'social') || [];
    const dev = getCached(c.slug,'dev') || [];
    metricCard.innerHTML = `<h3>${c.ticker} • Metrics</h3>
      <div class="small">Social latest: ${social.length ?
