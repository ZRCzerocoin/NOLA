<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOLA Exchange</title>
<style>
body {margin:0; padding:0; font-family:'Arial',sans-serif; background: radial-gradient(circle at center, #0c0014, #1a002b 80%); color:#fff;}
.container {width:90%; max-width:480px; margin:40px auto; background:rgba(255,255,255,0.05); border-radius:25px; padding:25px; backdrop-filter:blur(18px); box-shadow:0 0 25px rgba(180,0,255,0.3);}
h2{text-align:center; color:#e0b3ff; text-shadow:0 0 8px #b445ff;}
.input-box {margin-top:20px; padding:15px; background:rgba(255,255,255,0.05); border-radius:16px; position:relative;}
.input-box input{width:100%; padding:12px; border-radius:12px; border:none; background:rgba(255,255,255,0.05); color:#fff; font-size:16px;}
.suggestions { position:absolute; top:50px; left:0; width:100%; background:rgba(25,0,50,0.95); border-radius:12px; max-height:200px; overflow-y:auto; display:none; z-index:100; }
.suggestion-item { padding:10px; display:flex; align-items:center; cursor:pointer; }
.suggestion-item img { width:24px; height:24px; margin-right:10px; border-radius:12px; }
.price-tag { font-size:13px; opacity:0.8; position:absolute; right:12px; top:12px; }
.btn {width:100%; padding:14px; margin-top:20px; border:none; border-radius:20px; background: linear-gradient(135deg,#b445ff,#7013ff); color:#fff; font-size:18px; cursor:pointer;}
footer {text-align:center; margin:30px 0 10px 0; font-size:14px; opacity:0.8;}
footer a{color:#b445ff; text-decoration:none; margin:0 5px;}
#swapTokensBtn {position:absolute; left:50%; transform:translateX(-50%); top:calc(50% - 20px); width:36px; height:36px; border-radius:50%; background:rgba(30,20,60,0.8); border:2px solid rgba(255,255,255,0.05); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:16px; color:#fff; z-index:150;}
#walletConnectBtn {position:fixed; top:16px; right:16px; padding:10px 14px; border:none; border-radius:14px; background: linear-gradient(135deg,#b445ff,#7013ff); color:#fff; cursor:pointer; z-index:999; font-weight:600;}
.select-slippage {margin-top:10px; width:140px; padding:8px; border-radius:10px; background:rgba(255,255,255,0.03); border:none; color:#fff;}
#globalSearch {width:90%; margin:0 auto 20px auto; display:block; padding:12px; border-radius:12px; border:none; background:rgba(255,255,255,0.05); color:#fff; font-size:16px;}
</style>
</head>
<body>

<button id="walletConnectBtn">Connect Wallet</button>

<input type="text" id="globalSearch" placeholder="Search token by contract address">

<div class="container">
    <h2>NOLA Exchange</h2>

    <div class="input-box" id="fromBox">
        <input type="text" id="fromToken" placeholder="From Token">
        <div class="price-tag" id="fromPrice">—</div>
        <div class="suggestions" id="fromSuggestions"></div>
    </div>

    <div id="swapTokensBtn" title="Swap From ↔ To">⇅</div>

    <div class="input-box" id="toBox" style="margin-top:44px;">
        <input type="text" id="toToken" placeholder="To Token">
        <div class="price-tag" id="toPrice">—</div>
        <div class="suggestions" id="toSuggestions"></div>
    </div>

    <select id="slippage" class="select-slippage" title="Choose slippage">
        <option value="0.1">0.1%</option>
        <option value="0.5">0.5%</option>
        <option value="1" selected>1%</option>
        <option value="2">2%</option>
    </select>

    <input type="number" id="fromAmount" placeholder="Amount" style="margin-top:12px; padding:10px; border-radius:12px; width:100%; border:none; background:rgba(255,255,255,0.05); color:#fff; font-size:16px;">
    <input type="number" id="toAmount" placeholder="Equivalent" style="margin-top:12px; padding:10px; border-radius:12px; width:100%; border:none; background:rgba(255,255,255,0.05); color:#fff; font-size:16px;" readonly>

    <button class="btn" id="swapBtn">Swap</button>
</div>

<footer>
&copy; 2025 NOLA | <a href="Terms.html">Privacy & Terms</a> | 
<a href="#" id="nolTokenLink">NOLA Token</a> | 
<a href="#" id="xLink">X</a> | 
<a href="#" id="telegramLink">Telegram</a>
</footer>

<script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider/dist/umd/index.min.js"></script>

<script>
const PROJECT_ID = "6557a92e3698182727669d41cbeb95a1";
const CHAIN_ID = 137;
const ONEINCH = `https://api.1inch.io/v5.0/${CHAIN_ID}`;

let tokenList = [];
let provider, signer, walletConnected=false, userAddress=null;

// Prioritize major coins
const majorCoins = ["USDC","USDT","WBTC","WETH","MATIC","DAI"];

async function loadTokens(){
    try{
        const res = await fetch('https://tokens.coingecko.com/polygon-pos/all.json');
        const data = await res.json();
        tokenList = data.tokens;
        tokenList.sort((a,b)=>{
            if(majorCoins.includes(a.symbol) && !majorCoins.includes(b.symbol)) return -1;
            if(!majorCoins.includes(a.symbol) && majorCoins.includes(b.symbol)) return 1;
            return 0;
        });
    }catch(e){ console.error(e); }
}
loadTokens();

function setupAutocomplete(inputId, suggestionsId, priceId){
    const input = document.getElementById(inputId);
    const box = document.getElementById(suggestionsId);
    const price = document.getElementById(priceId);

    input.addEventListener('input', async ()=>{
        const val = input.value.toLowerCase();
        box.innerHTML = '';
        if(!val){ box.style.display='none'; price.textContent='—'; return; }
        const filtered = tokenList.filter(t => t.symbol.toLowerCase().startsWith(val) || t.name.toLowerCase().startsWith(val)).slice(0,6);
        filtered.forEach(t=>{
            const div = document.createElement('div');
            div.className='suggestion-item';
            div.innerHTML = `<img src="${t.logoURI}"><span>${t.symbol} - ${t.name}</span>`;
            div.onclick = ()=>{
                input.value = t.symbol;
                input.dataset.address = t.address;
                input.dataset.decimals = t.decimals;
                box.style.display='none';
                fetchPrice(t.address, price);
                updateToAmount();
            };
            box.appendChild(div);
        });
        box.style.display = filtered.length?'block':'none';
    });
}
setupAutocomplete('fromToken','fromSuggestions','fromPrice');
setupAutocomplete('toToken','toSuggestions','toPrice');

async function fetchPrice(address, elem){
    try{
        const res = await fetch(`https://api.coingecko.com/api/v3/simple/token_price/polygon-pos?contract_addresses=${address}&vs_currencies=usd`);
        const data = await res.json();
        const p = data[address.toLowerCase()]?.usd;
        elem.textContent = p ? `$${p.toFixed(6)}`:'—';
        return p || 0;
    }catch(e){ elem.textContent='—'; return 0; }
}

// fetch token info by address if not in list
async function fetchTokenInfo(address){
    try{
        const abi = ["function name() view returns (string)","function symbol() view returns (string)","function decimals() view returns (uint8)"];
        const contract = new ethers.Contract(address, abi, provider || new ethers.providers.JsonRpcProvider("https://polygon-rpc.com/"));
        const [name,symbol,decimals] = await Promise.all([contract.name(),contract.symbol(),contract.decimals()]);
        return {address, name, symbol, decimals, logoURI:"https://via.placeholder.com/24"};
    }catch(e){ console.error(e); return null; }
}

async function connectWallet(){
    if(walletConnected) return;
    if(window.ethereum){
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        walletConnected=true;
        document.getElementById('walletConnectBtn').textContent='Connected';
    } else {
        const wcProvider = await WalletConnectProvider.init({
            projectId: PROJECT_ID,
            chains:[CHAIN_ID],
            showQrModal:true
        });
        await wcProvider.enable();
        provider = new ethers.providers.Web3Provider(wcProvider);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        walletConnected=true;
        document.getElementById('walletConnectBtn').textContent='Connected';
    }
}
document.getElementById('walletConnectBtn').onclick = connectWallet;

// swap from/to
document.getElementById('swapTokensBtn').onclick = ()=>{
    const f = document.getElementById('fromToken');
    const t = document.getElementById('toToken');
    const tmp = f.value;
    const tmpAddr = f.dataset.address;
    const tmpDec = f.dataset.decimals;
    f.value = t.value; f.dataset.address = t.dataset.address; f.dataset.decimals = t.dataset.decimals;
    t.value = tmp; t.dataset.address = tmpAddr; t.dataset.decimals = tmpDec;
    fetchPrice(f.dataset.address, document.getElementById('fromPrice'));
    fetchPrice(t.dataset.address, document.getElementById('toPrice'));
    updateToAmount();
};

// live quote
async function updateToAmount(){
    const from = document.getElementById('fromToken');
    const to = document.getElementById('toToken');
    const amountInput = document.getElementById('fromAmount').value;
    const toAmount = document.getElementById('toAmount');

    if(!from.dataset.address || !to.dataset.address || !amountInput) { toAmount.value=''; return; }

    try{
        let fromDecimals = from.dataset.decimals ?? 18;
        let toDecimals = to.dataset.decimals ?? 18;

        const parsedAmount = ethers.utils.parseUnits(amountInput, fromDecimals);

        const url = `${ONEINCH}/quote?fromTokenAddress=${from.dataset.address}&toTokenAddress=${to.dataset.address}&amount=${parsedAmount.toString()}`;
        const res = await fetch(url);
        const data = await res.json();
        if(data.toTokenAmount){
            toAmount.value = ethers.utils.formatUnits(data.toTokenAmount, toDecimals);
        }
    }catch(e){ toAmount.value=''; }
}

document.getElementById('fromAmount').addEventListener('input', updateToAmount);
document.getElementById('fromToken').addEventListener('change', updateToAmount);
document.getElementById('toToken').addEventListener('change', updateToAmount);

// global search bar
document.getElementById('globalSearch').addEventListener('change', async (e)=>{
    const val = e.target.value.trim();
    if(!val) return;

    const to = document.getElementById('toToken');
    to.value = val;
    to.dataset.address = val;

    // check if token exists in list
    let token = tokenList.find(t=>t.address.toLowerCase()===val.toLowerCase());
    if(!token){
        token = await fetchTokenInfo(val);
        if(token) {
            to.dataset.decimals = token.decimals;
        }
    } else {
        to.dataset.decimals = token.decimals;
    }

    await fetchPrice(val, document.getElementById('toPrice'));
    updateToAmount();
});

// swap flow
document.getElementById('swapBtn').onclick = async ()=>{
    const from = document.getElementById('fromToken');
    const to = document.getElementById('toToken');
    const slippage = document.getElementById('slippage').value;
    const amountInput = document.getElementById('fromAmount').value;

    if(!from.dataset.address || !to.dataset.address || !amountInput){ alert('Fill all fields'); return; }

    await connectWallet();

    const fromDecimals = from.dataset.decimals ?? 18;
    const parsedAmount = ethers.utils.parseUnits(amountInput, fromDecimals);

    try{
        const swapUrl = `${ONEINCH}/swap?fromTokenAddress=${from.dataset.address}&toTokenAddress=${to.dataset.address}&amount=${parsedAmount.toString()}&fromAddress=${userAddress}&slippage=${slippage}`;
        const res = await fetch(swapUrl);
        const data = await res.json();
        if(data.tx){
            const tx = await signer.sendTransaction(data.tx);
            alert('Swap sent: '+tx.hash);
        } else { alert('Swap failed'); }
    }catch(e){ console.error(e); alert('Swap error'); }
};
</script>
</body>
</html>
