<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NOLA DEX</title>
<style>
    body { background:#0b0b0b; color:white; font-family:Arial; padding:20px; }
    .card { background:#111; padding:20px; border-radius:16px;
        max-width:420px; margin:auto; box-shadow:0 0 20px #000; }
    .row { display:flex; justify-content:space-between; align-items:center; margin:10px 0; }
    .token-btn { background:#1c1c1c; padding:10px 14px; border-radius:12px;
        display:flex; align-items:center; gap:8px; cursor:pointer; }
    .token-btn img { width:26px; height:26px; border-radius:50%; background:#333; }
    .input-box { background:#1c1c1c; padding:12px; border-radius:12px; width:100%;
        color:white; font-size:18px; border:none; }
    #modal { position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.85); display:none; padding:30px; }
    .token-item { padding:10px; display:flex; align-items:center; gap:10px;
        border-bottom:1px solid #222; cursor:pointer; }
    .token-item img { width:32px; height:32px; border-radius:50%; background:#333; }

    /* SPINNER */
    .spinner {
        width:16px; height:16px; border:3px solid #444;
        border-top-color:white; border-radius:50%;
        animation:spin 0.9s linear infinite; display:inline-block;
        margin-left:6px; vertical-align:middle;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="card">

    <h2>NOLA DEX Aggregator</h2>

    <!-- FROM -->
    <div class="row">
        <input id="fromAmount" class="input-box" placeholder="0.0" />
        <div id="fromTokenBtn" class="token-btn">
            <img id="fromIcon" src="">
            <span id="fromSymbol">Select</span>
        </div>
    </div>
    <div id="fromUsd" style="color:#777; font-size:14px;">$0.00</div>

    <!-- TO -->
    <div class="row">
        <input id="toAmount" class="input-box" placeholder="0.0" />
        <div id="toTokenBtn" class="token-btn">
            <img id="toIcon" src="">
            <span id="toSymbol">Select</span>
        </div>
    </div>
    <div id="toUsd" style="color:#777; font-size:14px;">$0.00</div>

    <button id="swapBtn" style="width:100%; margin-top:20px; padding:14px;
        font-size:18px; border:none; border-radius:12px; background:#4a00ff; color:white;">
        Swap Now
    </button>
</div>

<!-- Token Modal -->
<div id="modal">
    <input id="modalSearch" class="input-box" placeholder="Search name or contract..." style="margin-bottom:20px;">
    <div id="tokenList"></div>
</div>

<script>
const CHAIN = "137"; // Polygon
let selecting = null;
let tokensCache = {};

document.getElementById("fromTokenBtn").onclick = () => openModal("from");
document.getElementById("toTokenBtn").onclick = () => openModal("to");
document.getElementById("modalSearch").oninput = searchToken;
document.getElementById("fromAmount").oninput = () => updateConversion("from");
document.getElementById("toAmount").oninput = () => updateConversion("to");

/* OPEN TOKEN MODAL */
async function openModal(side) {
    selecting = side;
    document.getElementById("modal").style.display = "block";
    document.getElementById("modalSearch").value = "";
    document.getElementById("tokenList").innerHTML = "";
}

/* TOKEN SEARCH (1INCH) */
async function searchToken() {
    const q = document.getElementById("modalSearch").value.trim();

    if (q.length < 2) return;

    try {
        const res = await fetch(`https://api.1inch.dev/token/v1.2/${CHAIN}/search?query=${q}`, {
            headers: { "Authorization": "Bearer public" }
        });
        const data = await res.json();
        showTokenList(Object.values(data.tokens));
    } catch (e) {}
}

function showTokenList(list) {
    const box = document.getElementById("tokenList");
    box.innerHTML = "";
    list.forEach(t => {
        const div = document.createElement("div");
        div.className = "token-item";
        div.innerHTML = `
            <img src="${t.logoURI || ""}">
            <div><b>${t.symbol}</b><br><small>${t.name}</small></div>
        `;
        div.onclick = () => selectToken(t);
        box.appendChild(div);
    });
}

function selectToken(t) {
    tokensCache[selecting] = t;
    document.getElementById(selecting + "Symbol").innerText = t.symbol;
    document.getElementById(selecting + "Icon").src = t.logoURI || "";
    document.getElementById("modal").style.display = "none";
    updateUSD(selecting);
}

/* PRICE FETCHER WITH MULTI-LAYER FALLBACK */
async function fetchPriceUSD(addr) {
    let price;

    // ---------- 1) 1INCH ----------
    price = await promiseTimeout(3000, fetch1InchPrice(addr));
    if (price) return price;

    // ---------- 2) COINGECKO ----------
    price = await promiseTimeout(3000, fetchCoinGecko(addr));
    if (price) return price;

    // ---------- 3) DEXSCREENER ----------
    price = await promiseTimeout(3000, fetchDexScreener(addr));
    if (price) return price;

    return 0;
}

/* Timeout wrapper */
function promiseTimeout(ms, promise) {
    let timeout = new Promise(res => {
        setTimeout(() => res(null), ms);
    });
    return Promise.race([promise, timeout]);
}

/* 1inch → USD via USDC */
async function fetch1InchPrice(address) {
    try {
        const res = await fetch(
            `https://api.1inch.dev/swap/v6.0/${CHAIN}/quote?src=${address}&dst=0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174&amount=1000000000000000000`,
            { headers: { "Authorization": "Bearer public" } }
        );
        const data = await res.json();
        if (data.dstAmount) return Number(data.dstAmount) / 1e6;
    } catch {}
    return null;
}

/* COINGECKO fallback */
async function fetchCoinGecko(address) {
    try {
        const res = await fetch(`https://api.coingecko.com/api/v3/simple/token_price/polygon-pos?contract_addresses=${address}&vs_currencies=usd`);
        const data = await res.json();
        const key = Object.keys(data)[0];
        return data[key]?.usd || null;
    } catch {}
    return null;
}

/* DEXSCREENER fallback */
async function fetchDexScreener(address) {
    try {
        const res = await fetch(`https://api.dexscreener.io/latest/dex/tokens/${address}`);
        const data = await res.json();
        return data.pairs?.[0]?.priceUsd || null;
    } catch {}
    return null;
}

/* UPDATE USD VALUE */
async function updateUSD(side) {
    const t = tokensCache[side];
    if (!t) return;

    const el = document.getElementById(side + "Usd");
    el.innerHTML = `<span class="spinner"></span>`; // loading

    const amount = Number(document.getElementById(side + "Amount").value || 0);
    if (amount === 0) {
        el.innerText = "$0.00";
        return;
    }

    const p = await fetchPriceUSD(t.address);
    const total = (p * amount).toFixed(2);
    el.innerText = "$" + total;
}

/* LIVE USD REFRESH EVERY 6 SECONDS */
setInterval(() => {
    updateUSD("from");
    updateUSD("to");
}, 6000);

/* UPDATE TOKEN → TOKEN CONVERSION (1INCH) */
async function updateConversion(src) {
    const from = tokensCache.from;
    const to = tokensCache.to;
    if (!from || !to) return;

    const amount = Number(document.getElementById(src + "Amount").value || 0);

    try {
        const res = await fetch(
            `https://api.1inch.dev/swap/v6.0/${CHAIN}/quote?src=${from.address}&dst=${to.address}&amount=${amount * (10 ** from.decimals)}`,
            { headers: { "Authorization": "Bearer public" } }
        );
        const data = await res.json();

        if (data.dstAmount) {
            const recv = data.dstAmount / (10 ** to.decimals);
            if (src === "from") document.getElementById("toAmount").value = recv;
            else document.getElementById("fromAmount").value = recv;

            updateUSD("from");
            updateUSD("to");
        }
    } catch {}
}
</script>

</body>
</html>
