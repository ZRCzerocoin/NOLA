<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NOLA Exchange â€” WCv2 Enhanced</title>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<!-- Web3Modal v2+ & WalletConnect v2 SDKs (placeholders via unpkg/jsdelivr; ensure loading in production) -->
<script src="https://unpkg.com/@web3modal/standalone@2.3.6/dist/index.umd.min.js"></script>
<script src="https://unpkg.com/@walletconnect/ethereum-provider@2.9.0/dist/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<style>
/* ===== RESET & THEME (preserve your original background + glassy theme) ===== */
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
:root{
  --bg1: #0b0014;
  --bg2: #120022;
  --glass: rgba(255,255,255,0.04);
  --glass-2: rgba(255,255,255,0.02);
  --accent-1: #b445ff;
  --accent-2: #7013ff;
  --muted: rgba(255,255,255,0.65);
  --success: #2ee6a1;
  --danger: #ff6b6b;
  --yellow-cta: #ffc857;
  --container-max:560px;
}
html,body{height:100%}
body{
  background: radial-gradient(1000px 600px at 10% 10%, rgba(180,69,255,0.08), transparent 8%),
              radial-gradient(1000px 600px at 90% 85%, rgba(112,19,255,0.06), transparent 8%),
              linear-gradient(180deg,var(--bg1),var(--bg2));
  color:#fff;min-height:100vh; -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  padding:28px 16px 120px;
  position:relative;
  overflow-x:hidden;
}

/* particle canvas sits behind container but above background */
#particles{position:fixed;inset:0;z-index:0;pointer-events:none}

/* layout container */
.container{max-width:var(--container-max);margin:0 auto;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:20px;padding:20px;box-shadow: 0 10px 40px rgba(10,0,40,0.6);position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.03);z-index:10}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;box-shadow:var(--shadow)}
.title{font-weight:700;font-size:18px}
.sub{font-size:12px;color:var(--muted)}

/* top-right wallet */
.wallet-actions{display:flex;gap:10px;align-items:center}
.glassy-btn{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border:1px solid rgba(255,255,255,0.04);
  padding:8px 12px;border-radius:12px;color:#fff;cursor:pointer;display:inline-flex;gap:8px;align-items:center;font-weight:700;
  box-shadow: 0 6px 20px rgba(0,0,0,0.35);
  backdrop-filter: blur(8px);
  z-index:12;
}
.glassy-btn .status-dot{width:10px;height:10px;border-radius:50%;background:var(--danger);box-shadow:0 0 6px rgba(255,0,0,0.28)}
.glassy-btn.connected{border:1px solid rgba(255,255,255,0.06)}
.glassy-btn.connected .status-dot{background:var(--success);box-shadow:0 0 8px rgba(46,230,161,0.18)}
.glassy-btn[disabled]{opacity:0.55;cursor:not-allowed}

/* main card */
.card{margin-top:8px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:16px;border-radius:16px;border:1px solid rgba(255,255,255,0.03);position:relative;z-index:11}
.row{display:flex;gap:12px;align-items:center}

/* token input */
.token-box{padding:12px;border-radius:12px;background:linear-gradient(180deg,var(--glass),var(--glass-2));border:1px solid rgba(255,255,255,0.03)}
.token-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
.token-left{display:flex;gap:8px;align-items:center;min-width:0}
.token-symbol{
  width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;font-size:18px;
}
.token-input{background:transparent;border:none;color:inherit;font-size:16px;outline:none;min-width:0}
.token-label{color:var(--muted);font-weight:700;font-size:14px;cursor:pointer}

/* suggestions list */
.suggest-wrap{position:relative}
.suggestions{
  position:absolute;top:66px;left:0;right:0;z-index:80;max-height:320px;overflow:auto;border-radius:12px;padding:8px;border:1px solid rgba(255,255,255,0.04);
  background:linear-gradient(180deg, rgba(10,0,20,0.9), rgba(10,0,30,0.85));
  box-shadow:0 8px 40px rgba(0,0,0,0.6)
}
.suggestion{padding:10px;border-radius:10px;display:flex;gap:12px;align-items:center;cursor:pointer}
.suggestion:hover{background:rgba(255,255,255,0.02)}
.suggestion .sym{width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;font-weight:800}
.suggestion .meta{flex:1;min-width:0}
.suggestion .meta .n{font-weight:700}
.suggestion .meta .d{font-size:12px;color:var(--muted)}

/* slippage */
.dropdown{position:relative}
.slip-btn{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;cursor:pointer}
.slip-list{position:absolute;z-index:90;top:46px;left:0;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:6px;border:1px solid rgba(255,255,255,0.03);min-width:120px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.slip-item{padding:8px;border-radius:8px;cursor:pointer}
.slip-item:hover{background:rgba(255,255,255,0.02)}

/* swap CTA layout */
.bottom-fixed{
  position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:200;width:calc(100% - 40px);max-width:560px;display:flex;justify-content:center
}
.swap-main{
  width:100%;display:flex;justify-content:center;
  padding:14px 18px;border-radius:14px;backdrop-filter:blur(8px);
  background:linear-gradient(90deg,var(--accent-1),var(--accent-2));
  color:#0b0014;font-weight:900;font-size:16px;border:none;cursor:pointer;box-shadow:0 12px 40px rgba(180,69,255,0.16)
}
.swap-main[disabled]{opacity:0.5;cursor:not-allowed}

/* quick swap under slippage */
.quick-cta{
  background: linear-gradient(90deg,var(--yellow-cta),#f7b400);
  color:#1b1b1b; padding:10px 12px;border-radius:12px;border:none;font-weight:800;cursor:pointer;display:inline-flex;gap:8px;align-items:center;margin-top:8px
}
.quick-cta[disabled]{opacity:0.45;cursor:not-allowed}

/* message box */
.message{padding:10px;border-radius:10px;margin-top:12px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))}
.message.error{border-color:rgba(255,80,80,0.18);background:linear-gradient(180deg, rgba(255,80,80,0.02), rgba(255,80,80,0.01))}
.message.info{border-color:rgba(255,255,255,0.06)}

/* small helpers */
.row-between{display:flex;justify-content:space-between;align-items:center}
.kv{font-size:12px;color:var(--muted)}

/* spinner */
.spinner{width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.12);border-top-color:#fff;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* responsiveness */
@media (max-width:600px){
  .container{padding:14px;border-radius:14px}
  .logo{width:40px;height:40px}
  .token-symbol{width:40px;height:40px}
  .bottom-fixed{width:calc(100% - 28px)}
}
</style>
</head>
<body>
<canvas id="particles"></canvas>

<div class="container" id="app">
  <div class="header">
    <div class="brand">
      <div class="logo">N</div>
      <div>
        <div class="title">NOLA Exchange</div>
        <div class="sub">Swap quickly â€” now WCv2 & enhanced</div>
      </div>
    </div>

    <div class="wallet-actions">
      <button class="glassy-btn" id="btn-qr" title="Show QR code for wallet connect">QR</button>
      <button class="glassy-btn" id="btn-wallet">
        <span class="status-dot"></span>
        <span id="btn-wallet-text">Connect Wallet</span>
      </button>
    </div>
  </div>

  <div class="card">
    <!-- From -->
    <div style="display:flex;flex-direction:column;gap:10px">
      <div class="row token-box suggest-wrap" style="position:relative">
        <div class="token-row">
          <div class="token-left">
            <div class="token-symbol" id="from-symbol">USDC</div>
            <input id="from-amount" class="token-input" placeholder="0.0" inputmode="decimal" />
          </div>
          <div>
            <div class="token-label" id="from-label">USDC</div>
          </div>
        </div>

        <div class="suggestions" id="from-suggestions" style="display:none"></div>
      </div>

      <!-- To -->
      <div class="row token-box suggest-wrap" style="position:relative">
        <div class="token-row">
          <div class="token-left">
            <div class="token-symbol" id="to-symbol">---</div>
            <input id="to-amount" class="token-input" placeholder="0.0" inputmode="decimal" disabled />
          </div>
          <div>
            <div class="token-label" id="to-label">Select token</div>
          </div>
        </div>

        <div class="suggestions" id="to-suggestions" style="display:none"></div>
      </div>

      <!-- controls -->
      <div class="row-between" style="margin-top:6px">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="dropdown" id="slippage-dropdown">
            <button class="slip-btn" id="slip-btn">Slippage: <span id="slip-val">0.5%</span></button>
            <div class="slip-list" id="slip-list" style="display:none">
              <div class="slip-item" data-val="0.1">0.1%</div>
              <div class="slip-item" data-val="0.5">0.5%</div>
              <div class="slip-item" data-val="1">1%</div>
              <div class="slip-item" data-val="2">2%</div>
              <div class="slip-item" data-val="3">3%</div>
            </div>
          </div>

          <div style="display:flex;flex-direction:column">
            <div class="kv">Estimated</div>
            <div id="estimate" style="font-weight:800">-</div>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;align-items:flex-end;">
          <div class="kv">Network</div>
          <div id="network-label" style="font-weight:800">Polygon (137)</div>
        </div>
      </div>

      <div id="message-area"></div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div>
          <button id="quick-swap" class="quick-cta" disabled>Quick Swap</button>
        </div>
        <div style="font-size:12px;color:var(--muted);text-align:right">
          <div>1inch/0x price priority</div>
          <div>Fallbacks: Coingecko</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- bottom center swap -->
<div class="bottom-fixed">
  <button id="swap-btn" class="swap-main" disabled>Swap</button>
</div>

<!-- QR modal (fallback) -->
<div id="qr-modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:400">
  <div style="background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);max-width:420px;width:92%;text-align:center">
    <div style="font-weight:800;margin-bottom:6px">Scan QR to Connect</div>
    <div id="qr-code" style="margin:8px auto"></div>
    <div style="margin-top:8px">
      <button id="qr-close" class="glassy-btn">Close</button>
    </div>
  </div>
</div>

<script>
/* =================== CONFIG =================== */
// Replace with your WalletConnect v2 projectId
const WALLETCONNECT_PROJECT_ID = 'YOUR_PROJECT_ID_HERE';

// Network & constants
const POLYGON_CHAIN_ID = 137;
const POLYGON_CHAIN_HEX = '0x89';
const RPCS = {137: 'https://polygon-rpc.com/'};
const USDC_POLYGON = {symbol:'USDC',address:'0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174',decimals:6,chainId:137};
const ONE_INCH_API = 'https://api.1inch.io/v5.0';
const ZEROX_API = 'https://api.0x.org';
const COINGECKO_API = 'https://api.coingecko.com/api/v3';
const BIG_ALLOWANCE = ethers.constants.MaxUint256;

/* =================== STATE =================== */
let provider = null;      // ethers provider wrapper
let rawProvider = null;   // raw wallet provider returned from modal
let signer = null;
let userAddress = null;
let chainId = null;
let wcSession = null;

let tokenListCache = {timestamp:0, tokens:[]};
let quoteCache = null; // {key,quote,ts}

/* ========== helpers ========== */
const $ = id => document.getElementById(id);
function showMessage(html, type='info', ttl=6000){
  const area = $('message-area');
  area.innerHTML = `<div class="message ${type}">${html}</div>`;
  clearTimeout(area._t); area._t = setTimeout(()=>area.innerHTML='', ttl);
}
function parseError(e){
  if(!e) return 'Unknown error';
  const msg = (e && e.message) ? e.message.toLowerCase() : String(e).toLowerCase();
  if(msg.includes('insufficient')) return 'Insufficient funds for gas or token balance. Check wallet balance.';
  if(msg.includes('allowance') || msg.includes('approve') || msg.includes('not approved')) return 'Token allowance too low. You need to approve token spending.';
  if(msg.includes('user rejected') || msg.includes('user denied') || msg.includes('cancel')) return 'Transaction rejected by user.';
  return (e && e.message) ? e.message : String(e);
}
function setBtnState(){
  const fromAmt = parseFloat($('from-amount').value || 0);
  const toToken = $('to-label').textContent.trim();
  const estimate = $('estimate').textContent;
  const enable = fromAmt > 0 && toToken && toToken !== 'Select token' && estimate !== '-' && estimate !== '0';
  $('swap-btn').disabled = !enable;
  $('quick-swap').disabled = !enable;
}
function lockBodyScroll(lock){
  document.body.style.overflow = lock ? 'hidden' : '';
}
function debounce(fn, ms=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), ms); }; }

/* =================== WalletConnect v2 + Web3Modal setup =================== */
let web3Modal = null;

async function initWeb3Modal(){
  // Web3Modal standalone API (from @web3modal/standalone)
  // This is a minimal approach: Web3Modal will handle deep linking + QR + WCv2 providers where available
  if(!WALLETCONNECT_PROJECT_ID || WALLETCONNECT_PROJECT_ID === 'YOUR_PROJECT_ID_HERE'){
    console.warn('Using placeholder WalletConnect projectId - walletconnect v2 will not fully function until replaced.');
  }
  // create modal instance (Standalone)
  try{
    web3Modal = new window.Web3ModalStandalone.Web3Modal({
      projectId: WALLETCONNECT_PROJECT_ID,
      accentColor: 'default',
      theme: 'dark',
      walletConnectVersion: 2
    });
  }catch(e){
    console.warn('Web3Modal init error (possible CDN mismatch).', e);
  }
}

/* Connect wallet (uses web3Modal if available, else tries injected) */
async function connectWallet(useQr=false){
  try{
    // prefer injected if present and not forcing QR
    if(window.ethereum && !useQr){
      rawProvider = window.ethereum;
      provider = new ethers.providers.Web3Provider(rawProvider, 'any');
      await provider.send('eth_requestAccounts', []);
      signer = provider.getSigner();
    } else if(web3Modal){
      // open modal (handles deep links and QR)
      const wcProv = await web3Modal.connect();
      rawProvider = wcProv.provider ? wcProv.provider : wcProv; // stay flexible
      provider = new ethers.providers.Web3Provider(rawProvider, 'any');
      signer = provider.getSigner();
    } else {
      throw new Error('No Web3Modal available and no injected wallet.');
    }

    userAddress = await signer.getAddress();
    chainId = (await provider.getNetwork()).chainId;
    updateWalletUI(true);
    if(chainId !== POLYGON_CHAIN_ID){
      try { await switchToPolygon(); } catch(e){ showMessage('Please switch wallet to Polygon network (137).', 'error'); }
    } else {
      $('network-label').textContent = 'Polygon (137)';
    }
    await ensureDefaults();
  }catch(e){
    showMessage(parseError(e), 'error');
    console.error(e);
  }
}

/* Disconnect */
async function disconnectWallet(){
  try{
    if(web3Modal && web3Modal.disconnect) await web3Modal.disconnect();
    if(rawProvider && rawProvider.disconnect && typeof rawProvider.disconnect === 'function'){
      try{ await rawProvider.disconnect(); }catch(e){}
    }
  }catch(e){}
  provider = null; rawProvider = null; signer = null; userAddress = null; chainId = null;
  updateWalletUI(false);
}

/* Update wallet UI */
function updateWalletUI(connected){
  const btn = $('btn-wallet');
  const txt = $('btn-wallet-text');
  if(connected){
    btn.classList.add('connected');
    txt.textContent = userAddress ? `${userAddress.slice(0,6)}...${userAddress.slice(-4)}` : 'Connected';
    txt.title = userAddress || '';
  } else {
    btn.classList.remove('connected');
    txt.textContent = 'Connect Wallet';
    txt.title = '';
  }
}

/* Prompt wallet to switch chain to Polygon */
async function switchToPolygon(){
  if(!rawProvider) throw new Error('No wallet available');
  try{
    await rawProvider.request({method:'wallet_switchEthereumChain', params:[{chainId:POLYGON_CHAIN_HEX}]});
    chainId = (await provider.getNetwork()).chainId;
    $('network-label').textContent = 'Polygon (137)';
    return true;
  }catch(e){
    if(e && e.code === 4902 && rawProvider.request){
      try{
        await rawProvider.request({
          method: 'wallet_addEthereumChain',
          params: [{
            chainId: POLYGON_CHAIN_HEX,
            chainName: 'Polygon Mainnet',
            nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
            rpcUrls: [RPCS[137]],
            blockExplorerUrls: ['https://polygonscan.com']
          }]
        });
        return true;
      }catch(e2){ throw e2; }
    } else throw e;
  }
}

/* ===== Token list & suggestions prioritized by Coingecko 24h vol ===== */
async function fetchTopTokens(){
  const now = Date.now();
  if(tokenListCache.tokens.length && now - tokenListCache.timestamp < 5*60*1000) return tokenListCache.tokens;
  try{
    const res = await fetch(`${COINGECKO_API}/coins/markets?vs_currency=usd&order=volume_desc&per_page=50&page=1&platform=polygon-pos`);
    if(!res.ok) throw new Error('Coingecko fetch failed');
    const data = await res.json();
    const tokens = data.map(t => ({
      name: t.name,
      symbol: t.symbol.toUpperCase(),
      address: t.platforms && t.platforms['polygon-pos'] ? t.platforms['polygon-pos'] : null,
      volume_24h: t.total_volume,
      image: t.image
    })).filter(t=>t.address);
    tokenListCache = {timestamp:now,tokens};
    return tokens;
  }catch(e){
    console.warn('Coingecko fallback', e);
    const fallback = [USDC_POLYGON,
      {symbol:'WETH',address:'0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619',decimals:18},
      {symbol:'USDT',address:'0xc2132D05D31c914a87C6611C10748AEb04B58e8',decimals:6}
    ];
    tokenListCache = {timestamp:now,tokens:fallback};
    return fallback;
  }
}
function renderSuggestions(listEl, tokens){
  listEl.innerHTML = tokens.map(t=>`
    <div class="suggestion" data-address="${t.address}" data-symbol="${t.symbol}">
      <div class="sym">${t.symbol.slice(0,4)}</div>
      <div class="meta">
        <div class="n">${t.symbol} â€” ${t.name || ''}</div>
        <div class="d">Vol24h: ${t.volume_24h ? Number(t.volume_24h).toLocaleString() : 'N/A'}</div>
      </div>
    </div>
  `).join('');
}

/* Suggestion UX helpers (locks outside scroll when list active) */
function setupSuggestionBehavior(inputEl, listEl, symbolEl, labelEl, isFrom){
  let open = false;
  inputEl.addEventListener('focus', async () => {
    open = true;
    const tokens = await fetchTopTokens();
    renderSuggestions(listEl, tokens);
    listEl.style.display = 'block';
    lockBodyScroll(true);
    enableSuggestionScrollLock(listEl);
  });
  inputEl.addEventListener('input', async () => {
    const q = inputEl.value.trim().toLowerCase();
    const tokens = await fetchTopTokens();
    const filtered = tokens.filter(t => t.symbol.toLowerCase().includes(q) || (t.name||'').toLowerCase().includes(q));
    renderSuggestions(listEl, filtered.slice(0,50));
    listEl.style.display = 'block';
    lockBodyScroll(true);
    enableSuggestionScrollLock(listEl);
  });
  inputEl.addEventListener('blur', ()=> {
    setTimeout(()=>{ // allow click selection first
      if(!open){
        if(!inputEl.value.trim()){
          inputEl.value = labelEl.textContent || '';
        } else {
          labelEl.textContent = inputEl.value.trim();
          symbolEl.textContent = labelEl.textContent.split(' ')[0] || labelEl.textContent;
        }
      }
    }, 180);
  });
  listEl.addEventListener('click', (ev) => {
    const item = ev.target.closest('.suggestion');
    if(!item) return;
    const address = item.dataset.address;
    const symbol = item.dataset.symbol;
    labelEl.textContent = symbol;
    symbolEl.textContent = symbol;
    inputEl.value = '';
    listEl.style.display='none';
    open = false;
    lockBodyScroll(false);
    disableSuggestionScrollLock(listEl);
    if(isFrom) setDefaultToToken();
    setBtnState();
  });

  document.addEventListener('click', (e) => {
    if(!e.target.closest('.suggest-wrap')){
      listEl.style.display='none';
      open = false;
      lockBodyScroll(false);
      disableSuggestionScrollLock(listEl);
    }
  });
}
function enableSuggestionScrollLock(el){
  function prevent(e){ e.stopPropagation(); }
  el._handler = prevent;
  el.addEventListener('touchmove', prevent, {passive:false});
}
function disableSuggestionScrollLock(el){
  if(el._handler) el.removeEventListener('touchmove', el._handler);
}

/* ===== Defaults & behavior ===== */
async function ensureDefaults(){
  $('from-label').textContent = USDC_POLYGON.symbol;
  $('from-symbol').textContent = USDC_POLYGON.symbol;
  $('from-amount').value = '';
  const tokens = await fetchTopTokens();
  const top = tokens.find(t => t.symbol && t.symbol.toUpperCase() !== USDC_POLYGON.symbol) || tokens[0];
  if(top){
    $('to-label').textContent = top.symbol.toUpperCase();
    $('to-symbol').textContent = top.symbol.toUpperCase();
    $('to-amount').disabled = false;
  }
}
async function setDefaultToToken(){
  if($('to-label').textContent && $('to-label').textContent !== 'Select token') return;
  const tokens = await fetchTopTokens();
  const top = tokens[0];
  if(top){
    $('to-label').textContent = top.symbol.toUpperCase();
    $('to-symbol').textContent = top.symbol.toUpperCase();
    $('to-amount').disabled = false;
  }
}

/* ===== Quote & swap building (1inch primary, 0x fallback) ===== */
function quoteCacheKey(fromSymbol, toSymbol, amount, slippage){
  return `${fromSymbol}-${toSymbol}-${amount}-${slippage}`;
}
async function fetchQuote(fromAddr, toAddr, amount, userAddr){
  try{
    const url = `${ONE_INCH_API}/137/quote?fromTokenAddress=${fromAddr}&toTokenAddress=${toAddr}&amount=${amount}&fromAddress=${userAddr || ''}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('1inch quote failed');
    return await res.json();
  }catch(e){
    try{
      const url = `${ZEROX_API}/swap/v1/quote?buyToken=${toAddr}&sellToken=${fromAddr}&sellAmount=${amount}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('0x quote failed');
      return await res.json();
    }catch(e2){
      throw new Error('All quote sources failed');
    }
  }
}
async function getAllowance(tokenAddress, owner, spender){
  const abi = ["function allowance(address owner,address spender) view returns (uint256)"];
  const tk = new ethers.Contract(tokenAddress, abi, provider);
  return await tk.allowance(owner, spender);
}
async function doApprove(tokenAddress, spender){
  const erc20 = new ethers.Contract(tokenAddress, ["function approve(address spender,uint256 amount) returns (bool)"], signer);
  const tx = await erc20.approve(spender, BIG_ALLOWANCE);
  showMessage('Approval sent â€” waiting for confirmation', 'info', 12000);
  await tx.wait();
  return tx;
}

async function submitSwap(fromToken, toToken, fromAmount, slippagePct){
  try{
    if(!provider || !signer) throw new Error('Wallet not connected');
    const fromAddr = fromToken.address || fromToken;
    const toAddr = toToken.address || toToken;
    const user = await signer.getAddress();
    const key = quoteCacheKey(fromAddr,toAddr,fromAmount,slippagePct);
    let quote;
    if(quoteCache && quoteCache.key === key && (Date.now() - quoteCache.ts)<60_000){
      quote = quoteCache.quote;
    } else {
      quote = await fetchQuote(fromAddr,toAddr,fromAmount,user);
      quoteCache = {key, quote, ts:Date.now()};
    }

    // allowance target
    let allowanceTarget = quote && quote.allowanceTarget ? quote.allowanceTarget : null;
    if(!allowanceTarget){
      try{
        const res = await fetch(`${ONE_INCH_API}/137/swap?fromTokenAddress=${fromAddr}&toTokenAddress=${toAddr}&amount=${fromAmount}&fromAddress=${user}&slippage=${slippagePct}`);
        const body = await res.json();
        allowanceTarget = body.allowanceTarget || null;
      }catch(e){}
    }

    if(allowanceTarget){
      const allowance = await getAllowance(fromAddr, user, allowanceTarget);
      if(allowance.lt(ethers.BigNumber.from(fromAmount))){
        await doApprove(fromAddr, allowanceTarget);
      }
    } else {
      showMessage('Approval target unknown â€” attempting to fetch proper approval target.', 'info', 7000);
    }

    // build swap tx
    let swapTx = null;
    try{
      const params = new URLSearchParams({
        fromTokenAddress: fromAddr,
        toTokenAddress: toAddr,
        amount: fromAmount,
        fromAddress: user,
        slippage: String(slippagePct)
      });
      const res = await fetch(`${ONE_INCH_API}/137/swap?${params.toString()}`);
      if(!res.ok) throw new Error('1inch swap build failed');
      const body = await res.json();
      swapTx = body.tx;
    }catch(e){
      try{
        const url = `${ZEROX_API}/swap/v1/quote?sellToken=${fromAddr}&buyToken=${toAddr}&sellAmount=${fromAmount}&takerAddress=${user}`;
        const res2 = await fetch(url);
        const body2 = await res2.json();
        swapTx = {
          to: body2.to,
          data: body2.data,
          value: body2.value || '0x0'
        };
      }catch(e2){
        throw new Error('Failed to build swap transaction.');
      }
    }

    showMessage('Sending swap transaction... opening wallet', 'info', 6000);
    $('swap-btn').disabled = true; $('quick-swap').disabled = true;
    const txResponse = await signer.sendTransaction({to: swapTx.to, data: swapTx.data, value: swapTx.value || 0});
    const explorer = `https://polygonscan.com/tx/${txResponse.hash}`;
    showMessage(`Transaction submitted. <a href="${explorer}" target="_blank" style="color:var(--accent-1)">${txResponse.hash.slice(0,10)}...</a>`, 'info', 10000);
    await txResponse.wait();
    showMessage('Swap confirmed! ðŸŽ‰', 'info', 7000);
    setTimeout(()=>setBtnState(),300);
    return txResponse;
  }catch(e){
    const friendly = parseError(e);
    showMessage(friendly, 'error', 8000);
    setTimeout(()=>setBtnState(),300);
    throw e;
  }
}

/* Quick-swap: use cache if present, skip confirm */
async function doQuickSwap(){
  try{
    const fromSym = $('from-label').textContent.trim();
    const toSym = $('to-label').textContent.trim();
    const fromToken = await resolveToken(fromSym);
    const toToken = await resolveToken(toSym);
    const amt = parseAmountToBase(fromToken,$('from-amount').value);
    const sl = parseFloat($('slip-val').textContent.replace('%','')) || 0.5;
    await submitSwap(fromToken,toToken,amt,sl);
  }catch(e){}
}

/* parse amount */
function parseAmountToBase(token, valueStr){
  const decimals = token.decimals || 18;
  const sanitized = (String(valueStr).trim() || '0');
  const d = ethers.utils.parseUnits(sanitized, decimals);
  return d.toString();
}
async function resolveToken(symOrAddr){
  if(typeof symOrAddr === 'object') return symOrAddr;
  if(!symOrAddr) return USDC_POLYGON;
  if(symOrAddr.startsWith('0x')) return {address: symOrAddr};
  const tokens = await fetchTopTokens();
  const found = tokens.find(t => t.symbol.toUpperCase() === symOrAddr.toUpperCase());
  if(found) return {...found,decimals: found.decimals || 18};
  if(symOrAddr === 'USDC') return USDC_POLYGON;
  return {symbol:symOrAddr,address:ethers.constants.AddressZero,decimals:18};
}

/* Estimate */
async function estimate(){
  try{
    const fromSym = $('from-label').textContent.trim();
    const toSym = $('to-label').textContent.trim();
    if(!fromSym || !toSym || fromSym==='Select token' || toSym==='Select token') { $('estimate').textContent='-'; setBtnState(); return; }
    const fromToken = await resolveToken(fromSym);
    const toToken = await resolveToken(toSym);
    const humanAmt = $('from-amount').value || '0';
    if(parseFloat(humanAmt)<=0){ $('estimate').textContent='-'; setBtnState(); return; }
    const amtBase = parseAmountToBase(fromToken, humanAmt);
    const quote = await fetchQuote(fromToken.address, toToken.address, amtBase, userAddress || '');
    let out = '-';
    if(quote && (quote.toTokenAmount || quote.toTokenAmount !== undefined)){
      const toAmt = quote.toTokenAmount || quote.buyAmount;
      const decimals = toToken.decimals || 18;
      out = ethers.utils.formatUnits(ethers.BigNumber.from(toAmt.toString()), decimals);
      $('estimate').textContent = Number(out).toPrecision(6);
    } else if(quote && quote.buyAmount){
      out = ethers.utils.formatUnits(ethers.BigNumber.from(quote.buyAmount.toString()), toToken.decimals || 18);
      $('estimate').textContent = Number(out).toPrecision(6);
    } else {
      $('estimate').textContent = '-';
    }
    setBtnState();
  }catch(e){
    $('estimate').textContent='-';
    setBtnState();
  }
}

/* ========== UI wiring & init ========== */
document.addEventListener('DOMContentLoaded', async ()=>{
  // init modal (WCv2)
  await initWeb3Modal();
  await ensureDefaults();

  // suggestion behaviors
  setupSuggestionBehavior($('from-amount'), $('from-suggestions'), $('from-symbol'), $('from-label'), true);
  setupSuggestionBehavior($('to-amount'), $('to-suggestions'), $('to-symbol'), $('to-label'), false);

  // slippage dropdown
  const slipBtn = $('slip-btn'), slipList = $('slip-list');
  slipBtn.addEventListener('click', (e)=>{ e.stopPropagation(); slipList.style.display = (slipList.style.display==='block') ? 'none' : 'block'; });
  slipList.addEventListener('click', (e)=>{ const it = e.target.closest('.slip-item'); if(!it) return; $('slip-val').textContent = it.dataset.val + '%'; slipList.style.display='none'; });
  document.addEventListener('click', ()=>{ slipList.style.display='none'; });

  // wallet connect button
  $('btn-wallet').addEventListener('click', async ()=>{
    if(!provider){
      await connectWallet(false);
    } else {
      if(confirm('Disconnect wallet?')) await disconnectWallet();
    }
  });

  // QR button (explicit open modal for QR)
  $('btn-qr').addEventListener('click', async ()=>{
    // if web3Modal exists open it forcing QR
    if(web3Modal && web3Modal.open){
      try{
        // instruct modal to open with QR preference if supported
        await web3Modal.open();
      }catch(e){
        // fallback: show our QR modal for raw WalletConnect URI (only if provider returns URI)
        $('qr-modal').style.display='flex';
      }
    } else {
      $('qr-modal').style.display='flex';
    }
  });
  $('qr-close').addEventListener('click', ()=>{ $('qr-modal').style.display='none'; });

  // amounts change
  $('from-amount').addEventListener('input', debounce(()=>estimate(),300));
  $('to-amount').addEventListener('input', debounce(()=>estimate(),300));
  $('from-label').addEventListener('click', ()=>{ $('from-amount').focus(); $('from-amount').value=''; });
  $('to-label').addEventListener('click', ()=>{ $('to-amount').disabled = false; $('to-amount').focus(); });

  // swap actions
  $('swap-btn').addEventListener('click', async ()=>{
    if(!confirm('Confirm swap?')) return;
    const fromSym = $('from-label').textContent.trim();
    const toSym = $('to-label').textContent.trim();
    const fromToken = await resolveToken(fromSym);
    const toToken = await resolveToken(toSym);
    const amt = parseAmountToBase(fromToken, $('from-amount').value);
    const sl = parseFloat($('slip-val').textContent.replace('%','')) || 0.5;
    try{
      $('swap-btn').disabled = true; $('quick-swap').disabled = true;
      await submitSwap(fromToken,toToken,amt,sl);
    }catch(e){}
  });
  $('quick-swap').addEventListener('click', async ()=>{
    $('quick-swap').disabled = true;
    await doQuickSwap();
  });

  // injection event handlers
  if(window.ethereum){
    window.ethereum.on('accountsChanged', (accounts) => {
      if(accounts.length===0) disconnectWallet(); else { userAddress = accounts[0]; updateWalletUI(true); }
    });
    window.ethereum.on('chainChanged', (c) => { chainId = parseInt(c,16); if(chainId !== POLYGON_CHAIN_ID) showMessage('Not on Polygon â€” switch network.', 'error'); });
  }

  // initial estimate
  estimate();

  // initialize simple particle background (non-invasive)
  initParticles();
});

/* ================= particles: tiny lightweight effect ================ */
function initParticles(){
  const canvas = document.getElementById('particles');
  const ctx = canvas.getContext('2d');
  let w = canvas.width = innerWidth;
  let h = canvas.height = innerHeight;
  window.addEventListener('resize', ()=>{ w = canvas.width = innerWidth; h = canvas.height = innerHeight; });

  const pts = Array.from({length: 18}).map(()=>({
    x: Math.random()*w, y: Math.random()*h,
    vx: (Math.random()-0.5)*0.3, vy: (Math.random()-0.5)*0.3,
    r: 1 + Math.random()*3, hue: 260 + Math.random()*40
  }));

  function loop(){
    ctx.clearRect(0,0,w,h);
    pts.forEach(p=>{
      p.x += p.vx; p.y += p.vy;
      if(p.x<0) p.x = w; if(p.x> w) p.x=0;
      if(p.y<0) p.y = h; if(p.y> h) p.y=0;
      ctx.beginPath();
      ctx.fillStyle = `rgba(180,69,255,0.06)`;
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    });
    requestAnimationFrame(loop);
  }
  loop();
}

/* ============== misc helpers ============== */
document.addEventListener('input', (ev)=>{
  if(ev.target && (ev.target.id==='from-amount' || ev.target.id==='to-amount')) setBtnState();
});
</script>
</body>
</html>
