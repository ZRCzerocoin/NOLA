<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NOLA DEX</title>
<style>
    body {
        background:#0b0b0b; color:white; font-family:Arial;
        padding:20px;
    }
    .card {
        background:#111; padding:20px; border-radius:16px;
        max-width:420px; margin:auto; box-shadow:0 0 20px #000;
    }
    .row { display:flex; justify-content:space-between; align-items:center; margin:10px 0; }
    .token-btn {
        background:#1c1c1c; padding:10px 14px; border-radius:12px;
        display:flex; align-items:center; gap:8px; cursor:pointer;
    }
    .token-btn img {
        width:26px; height:26px; border-radius:50%; background:#333;
    }
    .input-box {
        background:#1c1c1c; padding:12px; border-radius:12px;
        width:100%; color:white; font-size:18px; border:none;
    }
    #modal {
        position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.85); display:none; padding:30px;
    }
    .token-item {
        padding:10px; display:flex; align-items:center; gap:10px;
        border-bottom:1px solid #222; cursor:pointer;
    }
    .token-item img { width:32px; height:32px; border-radius:50%; background:#333; }
</style>
</head>
<body>

<div class="card">

    <h2>NOLA DEX Aggregator</h2>

    <!-- FROM -->
    <div class="row">
        <input id="fromAmount" class="input-box" placeholder="0.0" />
        <div id="fromTokenBtn" class="token-btn">
            <img id="fromIcon" src="">
            <span id="fromSymbol">Select</span>
        </div>
    </div>
    <div id="fromUsd" style="color:#777; font-size:14px;">$0.00</div>

    <!-- TO -->
    <div class="row">
        <input id="toAmount" class="input-box" placeholder="0.0" />
        <div id="toTokenBtn" class="token-btn">
            <img id="toIcon" src="">
            <span id="toSymbol">Select</span>
        </div>
    </div>
    <div id="toUsd" style="color:#777; font-size:14px;">$0.00</div>

    <button id="swapBtn" style="width:100%; margin-top:20px; padding:14px;
        font-size:18px; border:none; border-radius:12px; background:#4a00ff; color:white;">
        Swap Now
    </button>
</div>

<!-- Token Modal -->
<div id="modal">
    <input id="modalSearch" class="input-box" placeholder="Search name or contract..." style="margin-bottom:20px;">
    <div id="tokenList"></div>
</div>

<script>
const CHAIN = "137"; // Polygon
const STABLES = [
    "0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174", // USDC
    "0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619", // WETH
    "0x0000000000000000000000000000000000001010", // MATIC
    "0xc2132D05D31c914a87C6611C10748AEb04B58e8F"  // USDT
];

let selecting = null;
let tokensCache = {};

document.getElementById("fromTokenBtn").onclick = () => openModal("from");
document.getElementById("toTokenBtn").onclick = () => openModal("to");
document.getElementById("modalSearch").oninput = searchToken;
document.getElementById("fromAmount").oninput = () => updateConversion("from");
document.getElementById("toAmount").oninput = () => updateConversion("to");

async function openModal(side) {
    selecting = side;
    document.getElementById("modal").style.display = "block";
    document.getElementById("modalSearch").value = "";
    document.getElementById("tokenList").innerHTML = "";
}

async function searchToken() {
    const q = document.getElementById("modalSearch").value.trim();

    // 1inch token info endpoint
    if (q.length >= 5) {
        try {
            const res = await fetch(`https://api.1inch.dev/token/v1.2/${CHAIN}/search?query=${q}`, {
                headers: { "Authorization": "Bearer public" }
            });
            const data = await res.json();
            showTokenList(Object.values(data.tokens));
        } catch (e) {}
    }
}

function showTokenList(list) {
    const box = document.getElementById("tokenList");
    box.innerHTML = "";
    list.forEach(t => {
        const item = document.createElement("div");
        item.className = "token-item";
        item.innerHTML = `
            <img src="${t.logoURI || ""}">
            <div>
                <b>${t.symbol}</b><br>
                <small>${t.name}</small>
            </div>
        `;
        item.onclick = () => selectToken(t);
        box.appendChild(item);
    });
}

function selectToken(t) {
    const side = selecting;
    tokensCache[side] = t;

    document.getElementById(side + "Symbol").innerText = t.symbol;
    document.getElementById(side + "Icon").src = t.logoURI || "";

    document.getElementById("modal").style.display = "none";

    updateUSD(side);
}

async function fetchUSDPrice(tokenAddress) {
    for (let stable of STABLES) {
        try {
            const res = await fetch(
                `https://api.1inch.dev/swap/v6.0/${CHAIN}/quote?src=${tokenAddress}&dst=${stable}&amount=1000000000000000000`,
                { headers: { "Authorization": "Bearer public" } }
            );
            const data = await res.json();
            if (data.dstAmount) {
                const stableDecimals = (stable === STABLES[0]) ? 6 : 18;
                const stableAmount = Number(data.dstAmount) / (10 ** stableDecimals);
                return stableAmount;
            }
        } catch (e) {}
    }
    return 0;
}

async function updateUSD(side) {
    const token = tokensCache[side];
    if (!token) return;

    const amount = Number(document.getElementById(side + "Amount").value || 0);
    if (amount === 0) {
        document.getElementById(side + "Usd").innerText = "$0.00";
        return;
    }

    const usd = await fetchUSDPrice(token.address);
    const total = (usd * amount).toFixed(2);

    document.getElementById(side + "Usd").innerText = `$${total}`;
}

async function updateConversion(source) {
    const from = tokensCache.from;
    const to = tokensCache.to;
    if (!from || !to) return;

    const amount = Number(document.getElementById(source + "Amount").value || 0);
    if (amount === 0) {
        document.getElementById("fromUsd").innerText = "$0.00";
        document.getElementById("toUsd").innerText = "$0.00";
        return;
    }

    // 1inch real route
    try {
        const res = await fetch(
            `https://api.1inch.dev/swap/v6.0/${CHAIN}/quote?src=${from.address}&dst=${to.address}&amount=${amount * (10 ** from.decimals)}`,
            { headers: { "Authorization": "Bearer public" } }
        );
        const data = await res.json();

        if (data.dstAmount) {
            const recv = Number(data.dstAmount) / (10 ** to.decimals);
            if (source === "from") document.getElementById("toAmount").value = recv;
            if (source === "to") document.getElementById("fromAmount").value = recv;

            updateUSD("from");
            updateUSD("to");
        }
    } catch(e){}
}
</script>

</body>
</html>
