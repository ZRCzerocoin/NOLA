<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NOLA Exchange</title>
<style>
/* ===== EXACT THEME YOU PROVIDED (unchanged look) ===== */
* {margin:0; padding:0; box-sizing:border-box; font-family:'Arial',sans-serif;}
body {overflow-x:hidden; background: radial-gradient(circle at center, #0c0014, #1a002b 80%); color:#fff; scroll-behavior:smooth;}
body::before { content:''; position:fixed; width:200%; height:200%; background: radial-gradient(circle, rgba(150,0,255,0.2), transparent 60%); animation: nebulaMove 20s infinite alternate ease-in-out; z-index:-2;}
@keyframes nebulaMove {0% {transform: translate(-10%,-10%);} 100% {transform: translate(5%,5%);} }
.particle { position:absolute; width:2px; height:2px; background:#b445ff; border-radius:50%; opacity:0.8; animation: floatParticle linear infinite;}
@keyframes floatParticle {0%{transform:translateY(0) translateX(0);opacity:0.8;}50%{transform:translateY(-50px) translateX(20px);opacity:0.4;}100%{transform:translateY(0) translateX(0);opacity:0.8;}}
.logo { width:150px; display:block; margin:25px auto; animation: logoGlow 5s ease-in-out infinite alternate, logoRotate 30s linear infinite;}
@keyframes logoGlow {0%{filter:drop-shadow(0 0 15px #9c00ff);}50%{filter:drop-shadow(0 0 35px #d15fff);}100%{filter:drop-shadow(0 0 15px #9c00ff);}}
@keyframes logoRotate {0%{transform:rotateY(0deg);}100%{transform:rotateY(360deg);}}
.container { width:90%; max-width:480px; margin:40px auto; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:25px; padding:25px; backdrop-filter:blur(18px); box-shadow:0 0 25px rgba(180,0,255,0.3); perspective:1000px;}
h2{text-align:center; font-size:28px; font-weight:600; margin-bottom:15px; color:#e0b3ff; text-shadow:0 0 8px #b445ff;}
.unified { margin-top:18px; padding:12px; background:rgba(255,255,255,0.04); border-radius:14px; border:1px solid rgba(255,255,255,0.07); display:flex; align-items:center; gap:12px; position:relative; box-shadow:0 6px 16px rgba(150,0,255,0.06); }
.unified .left { display:flex; align-items:center; gap:10px; min-width:0; }
.token-icon { width:44px; height:44px; border-radius:12px; background:rgba(255,255,255,0.02); display:flex; align-items:center; justify-content:center; overflow:hidden; }
.token-icon img{width:100%;height:100%;object-fit:cover;}
.token-symbol { font-weight:800; font-size:16px; color:#fff; text-overflow:ellipsis; overflow:hidden; white-space:nowrap; max-width:120px; }
.input-amount { margin-left:8px; flex:1; }
.input-amount input { width:100%; padding:10px 12px; border-radius:10px; border:none; background:rgba(255,255,255,0.03); color:#fff; font-size:15px; outline:none; }
.usd-right { position:absolute; right:12px; top:50%; transform:translateY(-50%); font-size:13px; color:rgba(255,255,255,0.9); font-weight:700; text-align:right; }
.suggestions { position:absolute; top:66px; left:0; right:0; background:rgba(25,0,50,0.98); border-radius:12px; padding:6px; max-height:260px; overflow:auto; display:none; z-index:120; box-shadow:0 10px 30px rgba(120,0,255,0.08); }
.suggestion-item { display:flex; align-items:center; gap:10px; padding:8px; border-radius:10px; cursor:pointer; justify-content:space-between; }
.suggestion-item:hover { background:rgba(120,0,255,0.12); }
.suggestion-left { display:flex; align-items:center; gap:10px; }
.controls { display:flex; gap:10px; align-items:center; margin-top:16px; }
.slippage { padding:8px 10px; border-radius:10px; background:rgba(255,255,255,0.03); color:#fff; border:none; }
.swap-row { display:flex; gap:10px; margin-top:18px; align-items:center; }
.btn { padding:14px; border:none; border-radius:20px; background: linear-gradient(135deg,#b445ff,#7013ff); color:#fff; font-size:18px; cursor:pointer; box-shadow:0 0 15px rgba(180,0,255,0.35); }
.btn:disabled{ opacity:0.45; cursor:not-allowed; }
.chat-toggle { position:fixed; right:20px; bottom:20px; background:#b445ff; padding:10px 14px; border-radius:20px; cursor:pointer; box-shadow:0 0 15px rgba(180,0,255,0.35); }
.chat-sidebar { position:fixed; right:20px; bottom:60px; width:320px; max-height:500px; background:rgba(0,0,0,0.3); backdrop-filter:blur(10px); border-radius:20px; padding:15px; overflow-y:auto; display:none; flex-direction:column;}
.chat-msg { margin-bottom:10px; padding:8px; border-radius:12px; font-size:14px; word-break:break-word; }
.chat-input { display:flex; margin-top:10px; }
.chat-input input{flex:1; padding:8px 10px; border-radius:12px; border:none; background:rgba(255,255,255,0.05); color:#fff;}
.chat-input button{margin-left:5px; padding:8px 12px; border-radius:12px; border:none; background:#b445ff; cursor:pointer;}
#usernameModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:2000; }
#usernameModal .modal-content { background:rgba(255,255,255,0.05); padding:25px; border-radius:20px; text-align:center; backdrop-filter:blur(15px); animation:modalIn 0.5s ease; }
#usernameModal input{padding:10px 12px; border-radius:12px; border:none; width:80%; margin-top:15px; background:rgba(255,255,255,0.05); color:#fff;}
#usernameModal button{margin-top:15px; padding:10px 20px; border:none; border-radius:12px; background:linear-gradient(135deg,#b445ff,#7013ff); color:#fff; cursor:pointer;}
@keyframes modalIn {from{opacity:0; transform:scale(0.8);}to{opacity:1; transform:scale(1);} }
.top-right-connect { position:fixed; right:18px; top:18px; z-index:70; display:flex; gap:10px; align-items:center; }
.addr-chip { padding:8px 12px; border-radius:12px; background:rgba(255,255,255,0.03); font-weight:700; display:none }
.connect-floating { background:linear-gradient(90deg,#b445ff,#7013ff); color:#fff; padding:10px 14px; border-radius:12px; border:none; cursor:pointer; font-weight:800; box-shadow:0 10px 30px rgba(106,0,255,0.12); }
.footer { position:fixed; left:0; right:0; bottom:12px; display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center; z-index:40; color:rgba(255,255,255,0.75); font-size:13px; }
.footer a { color:rgba(215,165,255,0.95); text-decoration:none; font-weight:700; margin-left:8px; }
@media (max-width:520px){ .unified .token-symbol{ max-width:90px; } }
</style>
</head>
<body>

<!-- PARTICLES -->
<script>
for(let i=0;i<60;i++){
  const p=document.createElement('div');
  p.className='particle';
  p.style.top=Math.random()*100+'%';
  p.style.left=Math.random()*100+'%';
  p.style.width=(Math.random()*3+1)+'px';
  p.style.height=(Math.random()*3+1)+'px';
  p.style.animationDuration=(Math.random()*10+5)+'s';
  document.body.appendChild(p);
}
</script>

<!-- LOGO -->
<img src="nol.png" class="logo" alt="NOLA logo">

<!-- top-right connect -->
<div class="top-right-connect">
  <div id="addrChip" class="addr-chip"></div>
  <button id="connectFloating" class="connect-floating">Connect Wallet</button>
</div>

<!-- MAIN CARD -->
<div class="container">
  <h2>NOLA Exchange</h2>

  <!-- FROM unified -->
  <div class="unified" id="fromBox" style="position:relative">
    <div class="left">
      <div class="token-icon" id="fromIcon"><img src="" alt="" style="display:none"></div>
      <div style="display:flex;flex-direction:column;min-width:0">
        <div class="token-symbol" id="fromSymbol">Select token</div>
        <div style="margin-top:6px">
          <input id="fromInput" placeholder="Type token symbol or name (e.g. pol)" style="padding:8px 10px;border-radius:10px;border:none;background:transparent;color:#fff;">
        </div>
      </div>
      <div class="input-amount" style="min-width:120px;">
        <input id="fromAmount" placeholder="Amount" inputmode="decimal">
      </div>
    </div>
    <div class="usd-right" id="fromUsd">â€”</div>
    <div class="suggestions" id="fromSuggest"></div>
  </div>

  <!-- TO unified -->
  <div class="unified" id="toBox" style="position:relative">
    <div class="left">
      <div class="token-icon" id="toIcon"><img src="" alt="" style="display:none"></div>
      <div style="display:flex;flex-direction:column;min-width:0">
        <div class="token-symbol" id="toSymbol">Select token</div>
        <div style="margin-top:6px">
          <input id="toInput" placeholder="Type token symbol or name" style="padding:8px 10px;border-radius:10px;border:none;background:transparent;color:#fff;">
        </div>
      </div>
      <div class="input-amount" style="min-width:120px;">
        <input id="toAmount" placeholder="Estimate" disabled>
      </div>
    </div>
    <div class="usd-right" id="toUsd">â€”</div>
    <div class="suggestions" id="toSuggest"></div>
  </div>

  <!-- controls -->
  <div class="controls">
    <select id="slippage" class="slippage" title="Select slippage">
      <option value="0.1">0.1%</option>
      <option value="0.5">0.5%</option>
      <option value="1" selected>1%</option>
      <option value="2">2%</option>
      <option value="custom">Custom</option>
    </select>
    <input id="customSlippage" placeholder="Custom %" style="padding:8px 10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:#fff;display:none;width:90px">
  </div>

  <div class="swap-row">
    <button id="swapBtn" class="btn" style="flex:1">Swap</button>
  </div>
</div>

<!-- CHAT -->
<div class="chat-toggle" id="chatToggle">ðŸ’¬ Chat</div>
<div class="chat-sidebar" id="chatSidebar">
  <h3 style="text-align:center">Public Chat</h3>
  <div id="chatMessages" style="flex:1;overflow-y:auto;"></div>
  <div class="chat-input">
    <input id="chatInput" placeholder="Type message...">
    <button id="sendChat" class="btn small">Send</button>
  </div>
</div>

<!-- USERNAME MODAL -->
<div id="usernameModal">
  <div class="modal-content">
    <h3>Choose Your NOLA Username ðŸŒŒ</h3>
    <input id="modalUsername" placeholder="Type your username">
    <button id="confirmUsername">Enter Chat</button>
  </div>
</div>

<!-- Footer -->
<div class="footer">
  <div>Â© 2025 NOLA â€” All rights reserved</div>
  <div><a href="PrivacyTerms.html" id="privacyTerms">Privacy & Terms</a> &nbsp; â€¢ &nbsp; <a href="#" id="xLink">X</a> &nbsp; <a href="#" id="tgLink">Telegram</a> &nbsp; <a href="#" id="siteLink">Website</a></div>
</div>

<!-- LIBS -->
<script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://unpkg.com/@web3modal/html@2.1.1/dist/index.js"></script>
<script src="https://unpkg.com/@walletconnect/web3modal@2.6.4/dist/w3m.min.js"></script>

<script>
/* ================= CONFIG ================= */
const CHAIN_ID = 137;
const ONEINCH_BASE = `https://api.1inch.io/v5.0/${CHAIN_ID}`;
const COINGECKO_TOKENS = 'https://tokens.coingecko.com/polygon-pos/all.json'; // confirmed by you
const COINGECKO_PRICE = (addr)=>`https://api.coingecko.com/api/v3/simple/token_price/polygon-pos?contract_addresses=${addr}&vs_currencies=usd`;
const WALLETCONNECT_PROJECT_ID = "6557a92e3698182727669d41cbeb95a1"; // your project id provided earlier
const GUN_PEERS = ['https://relay.peer.ooo/gun','https://gun-us.herokuapp.com/gun','https://gun-manhattan.herokuapp.com/gun'];
const NATIVE_1INCH = '0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee'; // 1inch native pseudo-address

/* ================= DOM refs ================= */
const fromInput = document.getElementById('fromInput'), toInput = document.getElementById('toInput');
const fromSuggest = document.getElementById('fromSuggest'), toSuggest = document.getElementById('toSuggest');
const fromSymbol = document.getElementById('fromSymbol'), toSymbol = document.getElementById('toSymbol');
const fromIconImg = document.querySelector('#fromIcon img'), toIconImg = document.querySelector('#toIcon img');
const fromAmount = document.getElementById('fromAmount'), toAmount = document.getElementById('toAmount');
const fromUsd = document.getElementById('fromUsd'), toUsd = document.getElementById('toUsd');
const slippageSel = document.getElementById('slippage'), customSlippage = document.getElementById('customSlippage');
const swapBtn = document.getElementById('swapBtn');
const connectFloating = document.getElementById('connectFloating'), addrChip = document.getElementById('addrChip');

/* ================= state ================= */
let tokenList = [], selectedFrom = null, selectedTo = null;
let provider = null, signer = null, userAddress = null, web3modal = null;

/* ================= utils ================= */
const $ = id => document.getElementById(id);
function short(a){ return a ? a.slice(0,6)+'â€¦'+a.slice(-4) : ''; }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
async function fetchJson(url){ const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

/* ================= load token list from coingecko ================= */
async function loadTokens(){
  try{
    const j = await fetchJson(COINGECKO_TOKENS);
    // coingecko tokens list has array of objects with { name, symbol, address, logo } or {logoURI}
    tokenList = Array.isArray(j) ? j.map(t=>{
      return {
        name: t.name || t.token_name || t.description || '',
        symbol: t.symbol || t.token_symbol || '',
        address: (t.address || t.contract_address || '').toLowerCase(),
        logoURI: t.logo || t.logoURI || t.image || t.logoURI || t.thumbnail || ''
      };
    }) : [];
    // fallback: if empty, try 1inch tokens endpoint
    if(!tokenList.length){
      try{
        const one = await fetchJson(`${ONEINCH_BASE}/tokens`);
        tokenList = Object.values(one.tokens || {}).map(t => ({ name: t.name, symbol: t.symbol, address: (t.address||'').toLowerCase(), logoURI: t.logoURI || '' }));
      }catch(e){}
    }
    console.log('tokenList length', tokenList.length);
    attachAutocomplete();
  }catch(e){
    console.error('loadTokens failed', e);
    // attempt to use 1inch token list as fallback
    try{
      const one = await fetchJson(`${ONEINCH_BASE}/tokens`);
      tokenList = Object.values(one.tokens || {}).map(t => ({ name: t.name, symbol: t.symbol, address: (t.address||'').toLowerCase(), logoURI: t.logoURI || '' }));
      attachAutocomplete();
    }catch(err){
      console.error('fallback 1inch tokens failed', err);
      attachAutocomplete(); // attach anyway so manual entries still work
    }
  }
}
loadTokens();

/* ================= price helper ================= */
async function fetchUsd(addr){
  try{
    if(!addr) return null;
    const json = await fetchJson(COINGECKO_PRICE(addr.toLowerCase()));
    return json[addr.toLowerCase()]?.usd ?? null;
  }catch(e){ return null; }
}

/* ================= suggestion builder ================= */
function buildSuggestion(tok){
  const outer = document.createElement('div');
  outer.className = 'suggestion-item';
  const left = document.createElement('div'); left.className='suggestion-left';
  const img = document.createElement('img'); img.src = tok.logoURI || ''; img.style.width='32px'; img.style.height='32px'; img.style.borderRadius='8px';
  img.onerror = ()=> img.style.display='none';
  const txt = document.createElement('div'); txt.style.display='flex'; txt.style.flexDirection='column';
  txt.innerHTML = `<strong style="font-weight:800">${escapeHtml(tok.symbol)}</strong><span style="font-size:12px;color:rgba(255,255,255,0.75)">${escapeHtml(tok.name)}</span>`;
  left.appendChild(img); left.appendChild(txt);
  outer.appendChild(left);
  const priceDiv = document.createElement('div'); priceDiv.style.fontWeight='800'; priceDiv.style.fontSize='13px'; priceDiv.textContent = '...';
  outer.appendChild(priceDiv);
  (async ()=>{
    const usd = await fetchUsd(tok.address);
    priceDiv.textContent = usd !== null ? ('$'+Number(usd).toFixed(4)) : '-';
  })();
  return outer;
}

/* ================= autocomplete attach (robust ordering: startsWith first) ================= */
function attachAutocomplete(){
  function bind(inputEl, suggestEl, onPick){
    inputEl.addEventListener('input', async ()=>{
      const q = (inputEl.value||'').trim().toLowerCase();
      suggestEl.innerHTML = '';
      if(!q){ suggestEl.style.display='none'; return; }
      // priority: symbol startsWith, name startsWith, symbol contains, name contains
      const startSym = tokenList.filter(t => (t.symbol||'').toLowerCase().startsWith(q));
      const startName = tokenList.filter(t => (t.name||'').toLowerCase().startsWith(q) && !startSym.includes(t));
      const containsSym = tokenList.filter(t => (t.symbol||'').toLowerCase().includes(q) && !startSym.includes(t) && !startName.includes(t));
      const containsName = token
