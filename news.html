<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NOL space â€” Crypto & X Trends</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="config.js"></script>
<style>
  body, html { margin:0; padding:0; font-family: Arial, sans-serif; background:#f5f6fa; color:#222; }
  header { background:#2c3e50; color:white; padding:1rem; text-align:center; display:flex; align-items:center; justify-content:center; gap:0.5rem; }
  header img { width:24px; height:24px; border-radius:50%; }
  #layout { display:flex; height:calc(100vh - 100px); }
  #sidebar { width:200px; background:#34495e; color:white; padding:1rem; box-sizing:border-box; }
  #sidebar h2 { font-size:1.2rem; margin:0 0 1rem 0; }
  #sidebar ul { padding:0; margin:0; list-style:none; }
  #sidebar li { padding:0.5rem 0; cursor:pointer; }
  #sidebar li:hover { text-decoration:underline; }
  #main { flex:1; overflow-y:auto; padding:1rem; }
  .section { margin-bottom:2rem; }
  .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(240px,1fr)); gap:1rem; }
  .card { background:white; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.1); padding:1rem; display:flex; flex-direction:column; }
  .meta { font-size:0.8rem; color:#555; margin:0.3rem 0; }
  .positive { color:green; }
  .negative { color:red; }
  .neutral { color:gray; }
  footer { background:#2c3e50; color:white; padding:1rem; text-align:center; }
  footer a { color:#f39c12; text-decoration:none; margin:0 0.5rem; }
</style>
</head>
<body>

<header>
  <img src="/Link/logo.gif" alt="NOL logo">
  <h1>NOL space</h1>
</header>

<div id="layout">
  <div id="sidebar">
    <h2>Sections</h2>
    <ul>
      <li data-sec="xtrends">X Trends</li>
      <li data-sec="news">News</li>
      <li data-sec="ethereum">Ethereum</li>
      <li data-sec="polygon">Polygon</li>
      <li data-sec="solana">Solana</li>
      <li data-sec="bnb">BNB</li>
    </ul>
  </div>
  <div id="main"><p>Loading dashboard...</p></div>
</div>

<footer>
  NOLA Â© All Rights Reserved.  
  <a href="https://nol.pages.dev" target="_blank">Website</a> | 
  <a href="https://x.com/NOLA_CHAIN" target="_blank">X</a> | 
  <a href="mailto:support@nola.work.gd">Support</a>
</footer>

<script>
const CACHE_KEY = "NOL_CACHE_TWEETS";
const CACHE_3DAY = 3*24*60*60*1000; // 3 days
const CACHE_24H = 24*60*60*1000;    // 24h incremental
const X_ACCOUNT = "@PEN2VA";
const MAX_INITIAL_FETCH = 50;
const DAILY_FETCH = 3;

// Chains & keywords
const CHAINS = {
  ethereum:["ETH","ETHEREUM","ETHEREUM 2.0","ETH/USD"],
  polygon:["POL","MATIC","POLYGON","MATIC/USD"],
  solana:["SOL","SOLANA","SOL/USD"],
  bnb:["BNB","BINANCE COIN","BNB/USD"]
};

const SMART_KEYWORDS = [
  "crypto","bitcoin","btc","ethereum","eth","polygon","matic","solana","sol","bnb","binance","web3",
  "trading","stocks","investment","investments","finance","market","defi","DeFi","NFT","nft","NFTs",
  "elon","musk","trump","fed","federal reserve","sec","government","bank","central bank","stock market",
  "bullish","bearish","pump","moon","dump","crash","rally","gain","loss","up","down","rocket","BTC","ETH",
  "SOL","MATIC","POL","BNB","staking","yield","liquidity","dex","exchange","token","tokens","smart contract",
  "staking","staking rewards","airdrops","airdrops","ICO","IDO","NFT collection","NFT project","DeFi project",
  "staking pool","staking protocol","L2","Layer 2","layer2","Layer2","layer2 scaling","Ethereum 2","EVM",
  "DAO","governance","crypto project","crypto influencer","trading signals","margin","options","futures",
  "Elon Musk","Trump","Federal Reserve","SEC","central bank","finance minister","investment bank","NASDAQ",
  "S&P","Dow Jones","blockchain","blockchain news","smart contract audit","crypto regulation","crypto law",
  "crypto policy","deflation","inflation","monetary policy","yield farming","liquidity pool","market cap",
  "market analysis","crypto adoption","crypto tax","crypto news","tradingview","bitcoin halving","ethereum merge",
  "tokenomics","NFT drop","whale","crypto whale","decentralized exchange","DEX","centralized exchange","CEX",
  "crypto scam","pump and dump","crypto fraud","crypto hack","blockchain security","crypto security"
];

// ========== SENTIMENT ==========
function estimateSentiment(txt) {
  txt = txt.toLowerCase();
  if(/pump|moon|up|gain|rocket/.test(txt)) return {label:"Bullish", class:"positive", icon:"ðŸš€"};
  if(/dump|down|crash|bear|loss/.test(txt)) return {label:"Bearish", class:"negative", icon:"ðŸ“‰"};
  return {label:"Neutral", class:"neutral", icon:"â€¢"};
}

// ========== CACHE ==========
function getCache() {
  const raw = localStorage.getItem(CACHE_KEY);
  if(!raw) return null;
  const data = JSON.parse(raw);
  const age = Date.now() - data.lastFetch;
  return data;
}

function setCache(tweets, lastFetch=Date.now()) {
  localStorage.setItem(CACHE_KEY, JSON.stringify({tweets, lastFetch}));
}

// ========== FETCH X ==========
async function fetchXTweets(initial=false) {
  let cache = getCache();
  const now = Date.now();

  if(cache && initial && now - cache.lastFetch < CACHE_3DAY) return cache.tweets;
  if(cache && !initial && now - cache.lastFetch < CACHE_3DAY && now - (cache.lastIncrement||0) < CACHE_24H) return cache.tweets;

  const bearer = window.BARRIER_KEY;
  if(!bearer) { console.error("BARRIER_KEY missing"); return []; }

  try {
    let url = `https://api.x.com/2/users/by/username/${X_ACCOUNT.replace('@','')}?user.fields=id`;
    const userRes = await fetch(url, { headers: {"Authorization":`Bearer ${bearer}`} });
    const userData = await userRes.json();
    const userId = userData.data?.id;
    if(!userId) return [];

    let max_results = initial ? MAX_INITIAL_FETCH : DAILY_FETCH;
    url = `https://api.x.com/2/users/${userId}/tweets?max_results=${max_results}&tweet.fields=created_at,text`;
    const tweetsRes = await fetch(url, { headers: {"Authorization":`Bearer ${bearer}`} });
    const json = await tweetsRes.json();
    const newTweets = json.data || [];

    // Merge with existing cache if incremental
    let merged = initial ? newTweets : [...(cache?.tweets||[]), ...newTweets];
    setCache(merged, cache?.lastFetch||now);
    if(!initial) {
      const updated = getCache();
      updated.lastIncrement = now;
      localStorage.setItem(CACHE_KEY, JSON.stringify(updated));
    }

    return merged;
  } catch(e) { console.error("Fetch X error:",e); return cache?.tweets||[]; }
}

// ========== RENDER ==========
function renderSection(title, tweets) {
  if(!tweets.length) return `<div class="section"><h2>${title}</h2><p>No tweets found</p></div>`;
  return `
    <div class="section"><h2>${title}</h2>
      <div class="grid">
        ${tweets.map(t => {
          const s = estimateSentiment(t.text);
          return `<div class="card">
            <h3>${s.icon} ${t.text}</h3>
            <div class="meta ${s.class}">Sentiment: ${s.label}</div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
}

// Categorize tweets
function categorizeTweets(tweets) {
  const sections = {xtrends:[], ethereum:[], polygon:[], solana:[], bnb:[]};
  tweets.forEach(t=>{
    const text = t.text.toUpperCase();
    let matched = false;
    for(const chain in CHAINS) {
      if(CHAINS[chain].some(k=>text.includes(k.toUpperCase()))) { sections[chain].push(t); matched=true; break; }
    }
    if(!matched) sections.xtrends.push(t);
  });
  return sections;
}

// ========== COINGECKO PRICES ==========
async function fetchPrices() {
  const apiKey = window.COING_API;
  const coins = ["bitcoin","ethereum","polygon","solana","binancecoin"];
  const url = `https://api.coingecko.com/api/v3/simple/price?ids=${coins.join(',')}&vs_currencies=usd&include_24hr_change=true`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    return data;
  } catch(e){ console.error("Coingecko error:",e); return {}; }
}

// Render prices
async function renderPrices() {
  const prices = await fetchPrices();
  const main = document.getElementById("main");
  let html = '';
  for(const coin in prices) {
    const p = prices[coin];
    html += `<div class="card">
      <h3>${coin.toUpperCase()}</h3>
      <div class="meta">Price: $${p.usd.toLocaleString()}</div>
      <div class="meta">24h Change: <span class="${p.usd_24h_change>=0?'positive':'negative'}">${p.usd_24h_change.toFixed(2)}%</span></div>
    </div>`;
  }
  main.innerHTML = html;
}

// ========== LOAD ==========
async function loadSection(section) {
  const main = document.getElementById("main");
  main.innerHTML = "<p>Loading...</p>";

  const initial = true;
  const tweets = await fetchXTweets(initial);
  const sections = categorizeTweets(tweets);

  if(section==='news') main.innerHTML = '<div class="section"><h2>ðŸ“° News</h2><p>Soon</p></div>';
  else if(section==='xtrends') main.innerHTML = renderSection("ðŸ”¥ X Trends", sections.xtrends);
  else if(['ethereum','polygon','solana','bnb'].includes(section)) main.innerHTML = renderSection(section.toUpperCase(), sections[section]);
}

// Sidebar click
document.querySelectorAll("#sidebar li").forEach(li=>{
  li.addEventListener("click",()=>loadSection(li.getAttribute("data-sec")));
});

// Default load
loadSection("xtrends");

// Prices refresh every 15s
setInterval(renderPrices, 15000);

</script>
</body>
</html>
