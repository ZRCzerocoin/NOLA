<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NOLA Exchange — Polygon DEX Aggregator</title>
<link rel="icon" href="nol.png" />
<style>
/* ===== EXACT FIRST THEME (Mystical Purplism) ===== */
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Arial,system-ui,-apple-system;}
html,body{height:100%;background:radial-gradient(circle at center,#0c0014,#1a002b 80%);color:#fff;overflow-y:auto}
:root{--neon1:#6A00FF;--neon2:#A243FF;--glass:rgba(255,255,255,0.03);--card-radius:18px}

/* Particles + background aura */
body::before{content:"";position:fixed;inset:-20% -20% auto -20%;height:140%;z-index:-3;
background:radial-gradient(800px 500px at 10% 10%, rgba(106,0,255,0.12), transparent 8%),
radial-gradient(900px 500px at 90% 85%, rgba(162,67,255,0.09), transparent 6%),
linear-gradient(180deg,#050205 0%, #0b0310 100%);
filter:blur(14px) saturate(1.05);}

/* small decorative particles */
.particle{position:fixed;border-radius:50%;pointer-events:none;mix-blend-mode:screen;z-index:-2}

/* Logo center */
header{width:100%;display:flex;align-items:center;justify-content:center;padding:24px 18px 6px;position:relative}
.logo{width:120px;height:120px;border-radius:20px;display:flex;align-items:center;justify-content:center;overflow:hidden;
 background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 10px 40px rgba(106,0,255,0.12)}
.logo img{width:72%;height:72%;object-fit:contain}
.logo-aura{position:absolute;top:8px;left:50%;transform:translateX(-50%);width:180px;height:180px;border-radius:50%;
 background:radial-gradient(circle at 40% 40%, rgba(162,67,255,0.14), transparent 40%);filter:blur(20px);z-index:-1}
@keyframes logoRotate{0%{transform:rotateY(0deg)}100%{transform:rotateY(360deg)}}
.logo{animation:logoRotate 30s linear infinite}

/* Top-right connect (floating) */
.top-right{position:fixed;right:18px;top:18px;display:flex;gap:12px;align-items:center;z-index:60}
.connect-btn{background:linear-gradient(90deg,var(--neon1),var(--neon2));color:#fff;border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(106,0,255,0.12)}
.addr-chip{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:12px;font-weight:700;font-size:13px}

/* Layout */
.wrap{width:100%;max-width:1100px;margin:18px auto;padding:18px;display:grid;grid-template-columns:1fr 360px;gap:24px}
@media(max-width:980px){.wrap{grid-template-columns:1fr;padding:12px}}

/* Left panel (exchange) */
.panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:20px;padding:18px;border:1px solid rgba(162,67,255,0.06);backdrop-filter:blur(12px)}
.title{font-size:18px;color:#EED9FF;font-weight:700;letter-spacing:0.6px;margin-bottom:12px;text-align:center;text-shadow:0 0 8px #b445ff}

/* Swap box */
.swap-box{border-radius:16px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
.row{display:flex;gap:12px;align-items:center}
.col{display:flex;flex-direction:column;gap:8px}
.input{position:relative}
.input input{width:100%;padding:12px;border-radius:12px;border:none;background:rgba(2,1,6,0.6);color:#fff;font-size:16px;outline:none}
.small{width:140px}
.suggestions{position:absolute;left:0;right:0;top:56px;background:linear-gradient(180deg, rgba(6,2,10,0.98), rgba(12,3,20,0.98));border-radius:12px;padding:8px;border:1px solid rgba(162,67,255,0.06);max-height:260px;overflow:auto;display:none;z-index:80}
.s-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;cursor:pointer}
.s-item img{width:32px;height:32px;border-radius:8px;object-fit:cover}
.meta{display:flex;flex-direction:column}
.sym{font-weight:800}
.nm{font-size:12px;color:rgba(255,255,255,0.6)}
.controls{display:flex;gap:12px;margin-top:12px;align-items:center;justify-content:space-between}
.quote{margin-top:14px;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02)}
.cta{display:flex;gap:8px}

/* chart */
.chart-wrap{margin-top:18px;height:420px;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);display:none}
.chart-wrap iframe{width:100%;height:100%;border:0;background:#08020b}

/* Right panel (chat) */
.sidebar{display:flex;flex-direction:column;gap:12px}
.side-card{padding:14px;border-radius:16px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);backdrop-filter:blur(8px)}
.chat-header{display:flex;align-items:center;justify-content:space-between}
.chat-list{height:360px;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:8px}
.chat-msg{padding:10px;border-radius:12px;background:rgba(106,0,255,0.06)}
.chat-who{font-weight:800;margin-bottom:6px}

/* username modal */
#usernameModal{position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.7);z-index:9999}
.modal{background:rgba(255,255,255,0.03);padding:20px;border-radius:14px;width:320px;text-align:center;border:1px solid rgba(162,67,255,0.06);box-shadow:0 20px 60px rgba(106,0,255,0.12)}
.modal input{width:100%;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.02);color:#fff;margin-top:12px}

/* small helpers */
.hidden{display:none!important}
.addr-top{position:absolute;left:18px;top:18px}
</style>
</head>
<body>

<!-- particles -->
<script>
for(let i=0;i<60;i++){
  const d=document.createElement('div');
  d.className='particle';
  const s=(Math.random()*24+6)+'px';
  d.style.width=s; d.style.height=s;
  d.style.left=(Math.random()*100)+'%'; d.style.top=(Math.random()*100)+'%';
  d.style.background=`radial-gradient(circle, rgba(162,67,255,0.6), rgba(106,0,255,0.3))`;
  d.style.opacity=(Math.random()*0.6+0.15);
  d.style.animationDuration=(Math.random()*10+5)+'s';
  document.body.appendChild(d);
}
</script>

<header>
  <div class="logo-aura"></div>
  <div class="logo"><img src="nol.png" alt="NOLA"></div>

  <div class="top-right">
    <div id="addrChip" class="addr-chip" style="display:none"></div>
    <button id="connectWalletFloating" class="connect-btn">Connect Wallet</button>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: Exchange -->
  <div class="panel">
    <div class="title">NOLA — Polygon DEX Aggregator</div>

    <div class="swap-box">
      <div class="col">
        <div class="label">From</div>
        <div class="row" style="align-items:stretch">
          <div class="input" style="flex:1">
            <input id="fromInput" placeholder="Token symbol, name or paste address — e.g. MATIC, USDC, pol...">
            <div class="suggestions" id="fromSuggest"></div>
          </div>
          <div class="input small">
            <input id="fromAmount" placeholder="Amount" inputmode="decimal">
          </div>
        </div>
      </div>

      <div class="col" style="margin-top:12px">
        <div class="label">To</div>
        <div class="row">
          <div class="input" style="flex:1">
            <input id="toInput" placeholder="Token symbol, name or paste address">
            <div class="suggestions" id="toSuggest"></div>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="quote" id="quoteText">Select tokens and click Get Quote</div>
        <div class="cta">
          <button id="quoteBtn" class="btn small">Get Quote</button>
          <button id="swapBtn" class="btn small" disabled>Swap</button>
        </div>
      </div>

      <div class="chart-wrap" id="chartWrap">
        <iframe id="chartFrame" src=""></iframe>
      </div>
    </div>
  </div>

  <!-- RIGHT: Chat only -->
  <div class="sidebar">
    <div class="side-card">
      <div class="chat-header">
        <div style="font-weight:800">Public Chat</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.6)">Live · Global</div>
      </div>

      <div id="chatMessages" class="chat-list"></div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <input id="chatInput" placeholder="Message..." style="flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:#fff">
        <button id="sendChat" class="btn small">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- username modal (themed) -->
<div id="usernameModal">
  <div class="modal">
    <div style="font-weight:800;font-size:18px;color:#e7ccff">Choose your NOLA username</div>
    <input id="modalName" placeholder="e.g. LunaTrader">
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
      <button id="confirmName" class="btn small">Enter Chat</button>
      <button id="cancelName" class="btn small" style="background:rgba(255,255,255,0.04)">Cancel</button>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://unpkg.com/@web3modal/html@2.1.1/dist/index.js"></script>
<script src="https://unpkg.com/@walletconnect/web3modal@2.6.4/dist/w3m.min.js"></script>

<script>
/* ================= CONFIG ================= */
const CHAIN_ID = 137; // Polygon
const ONEINCH_BASE = `https://api.1inch.io/v5.0/${CHAIN_ID}`;
const COINGECKO_TOKEN_PRICE = (addr)=>`https://api.coingecko.com/api/v3/simple/token_price/polygon-pos?contract_addresses=${addr}&vs_currencies=usd`;
const WALLETCONNECT_PROJECT_ID = "WALLETCONNECT_PROJECT_ID"; // <-- paste your WalletConnect v2 Project ID here
const GUN_PEERS = [
  'https://relay.peer.ooo/gun',
  'https://gun-us.herokuapp.com/gun',
  'https://gun-manhattan.herokuapp.com/gun'
];
const INITIAL_NOLA_TOKEN = '0x1515546B052151D5eb8CCB1bcf2857E0C6f51451'; // your NOLA token chart on startup

/* ================= UI refs ================= */
const fromInput = document.getElementById('fromInput');
const toInput = document.getElementById('toInput');
const fromSuggest = document.getElementById('fromSuggest');
const toSuggest = document.getElementById('toSuggest');
const fromAmount = document.getElementById('fromAmount');
const quoteBtn = document.getElementById('quoteBtn');
const swapBtn = document.getElementById('swapBtn');
const quoteText = document.getElementById('quoteText');
const chartWrap = document.getElementById('chartWrap');
const chartFrame = document.getElementById('chartFrame');
const connectWalletFloating = document.getElementById('connectWalletFloating');
const addrChip = document.getElementById('addrChip');

const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChat');

const usernameModal = document.getElementById('usernameModal');
const modalName = document.getElementById('modalName');
const confirmName = document.getElementById('confirmName');
const cancelName = document.getElementById('cancelName');

/* ================= state ================= */
let tokenList = [];
let selectedFrom = null;
let selectedTo = null;
let provider = null, signer = null, userAddress = null;

/* ================= fetch tokens (1inch) ================= */
async function loadTokens(){
  try{
    const r = await fetch(`${ONEINCH_BASE}/tokens`);
    const d = await r.json();
    tokenList = Object.values(d.tokens || {});
    console.log('tokens loaded', tokenList.length);
  }catch(e){ console.error('token list error', e); }
}
loadTokens();

/* ================= autocomplete ================= */
function makeItem(t){
  const div = document.createElement('div'); div.className='s-item';
  div.innerHTML = `<img src="${t.logoURI||''}" onerror="this.style.display='none'"><div class="meta"><div class="sym">${t.symbol}</div><div class="nm">${t.name}</div></div>`;
  return div;
}
function attachAuto(inputEl, suggestEl, onSelect){
  inputEl.addEventListener('input', async ()=>{
    const q = inputEl.value.trim().toLowerCase();
    suggestEl.innerHTML='';
    if(!q){ suggestEl.style.display='none'; return; }
    const bySym = tokenList.filter(t=>t.symbol && t.symbol.toLowerCase().includes(q));
    const byName = tokenList.filter(t=>t.name && t.name.toLowerCase().includes(q) && !bySym.includes(t));
    const res = [...bySym, ...byName].slice(0,8);
    for(const tok of res){
      const item = makeItem(tok);
      // add USD price small fetch
      (async ()=>{
        try{
          const priceResp = await fetch(COINGECKO_TOKEN_PRICE(tok.address));
          const priceData = await priceResp.json();
          const addr = tok.address.toLowerCase();
          const usd = (priceData[addr] && priceData[addr].usd) ? priceData[addr].usd : null;
          if(usd !== null){
            const priceEl = document.createElement('div'); priceEl.style.marginLeft='auto'; priceEl.style.fontWeight='800'; priceEl.style.fontSize='13px'; priceEl.textContent = '$' + Number(usd).toFixed(4);
            item.appendChild(priceEl);
          }
        }catch(e){}
      })();
      item.onclick = ()=>{ inputEl.value = tok.symbol; suggestEl.style.display='none'; onSelect(tok); };
      suggestEl.appendChild(item);
    }
    suggestEl.style.display = res.length ? 'block' : 'none';
  });

  inputEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      const q = inputEl.value.trim().toLowerCase();
      if(!q) return;
      const found = tokenList.find(t=>(t.symbol||'').toLowerCase()===q || (t.name||'').toLowerCase()===q || (t.address||'').toLowerCase()===q);
      if(found){ inputEl.value = found.symbol; suggestEl.style.display='none'; onSelect(found); return; }
      const fuzzy = tokenList.find(t => (t.symbol||'').toLowerCase().includes(q) || (t.name||'').toLowerCase().includes(q));
      if(fuzzy){ inputEl.value = fuzzy.symbol; suggestEl.style.display='none'; onSelect(fuzzy); return; }
      suggestEl.style.display='none';
    }
  });
}

attachAuto(fromInput, fromSuggest, tok=>{
  selectedFrom = tok; openChart(tok.address); updateQuotePreview();
});
attachAuto(toInput, toSuggest, tok=>{
  selectedTo = tok; openChart(tok.address); updateQuotePreview();
});

/* ================= chart open logic (Gecko first, Dexscreener fallback) ================= */
function openChart(address){
  if(!address) return;
  // ensure address normalized
  const a = address.toLowerCase();
  // GeckoTerminal embed (preferred)
  const gecko = `https://www.geckoterminal.com/polygon/tokens/${a}?embed=1`;
  const dexs = `https://www.dexscreener.com/polygon/${a}?embed=1`;
  chartFrame.src = gecko;
  chartWrap.style.display = 'block';
  // if gecko fails to load after timeout, fallback to dexscreener
  // Listen for load event and error fallback
  let fallbackTimer = setTimeout(()=>{ /* if still not loaded, switch */ chartFrame.src = dexs; }, 3500);
  chartFrame.onload = ()=>{ clearTimeout(fallbackTimer); /* success */ };
  chartFrame.onerror = ()=>{ clearTimeout(fallbackTimer); chartFrame.src = dexs; };
}

/* open NOLA chart on start */
openChart(INITIAL_NOLA_TOKEN);

/* ================= CoinGecko USD price function ================= */
async function fetchUsdPrice(address){
  try{
    const resp = await fetch(COINGECKO_TOKEN_PRICE(address));
    const json = await resp.json();
    const v = json[address.toLowerCase()]?.usd ?? null;
    return v;
  }catch(e){ return null; }
}

/* ================= Quote & Swap (1inch) ================= */
function toDecimalBigInt(valueStr, decimals){
  const decimalsNum = decimals || 18;
  const [intPart, decPart=''] = String(valueStr).split('.');
  const intBig = BigInt(intPart || '0') * (BigInt(10) ** BigInt(decimalsNum));
  const decNormalized = (decPart + '0'.repeat(decimalsNum)).slice(0, decimalsNum).slice(0, decimalsNum);
  const decBig = BigInt(decNormalized || '0') * (BigInt(10) ** BigInt(0)) / (BigInt(10) ** BigInt(decPart.length || 0));
  // Simpler approach:
  const combined = BigInt((intPart || '0')) * (BigInt(10) ** BigInt(decimalsNum)) + BigInt((decPart + '0'.repeat(decimalsNum)).slice(0,decimalsNum));
  return combined;
}

function toBigIntAmount(value, decimals){
  const d = decimals || 18;
  const parts = String(value).split('.');
  if(parts.length === 1) return BigInt(parts[0]) * (BigInt(10)**BigInt(d));
  const intPart = parts[0] || '0';
  const decPart = (parts[1] || '').slice(0,d).padEnd(d,'0');
  return BigInt(intPart) * (BigInt(10)**BigInt(d)) + BigInt(decPart);
}

quoteBtn.addEventListener('click', async ()=>{
  if(!selectedFrom || !selectedTo) return alert('Select From and To tokens first');
  const amount = (fromAmount.value||'').trim();
  if(!amount) return alert('Enter amount');
  quoteText.textContent = 'Fetching best price...';
  try{
    const amountInt = toBigIntAmount(amount, selectedFrom.decimals || 18).toString();
    const url = `${ONEINCH_BASE}/quote?fromTokenAddress=${selectedFrom.address}&toTokenAddress=${selectedTo.address}&amount=${amountInt}`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('quote failed');
    const data = await r.json();
    const out = Number(data.toTokenAmount) / (10 ** (selectedTo.decimals || 18));
    // fetch USD price of toToken for display
    const usd = await fetchUsdPrice(selectedTo.address);
    quoteText.innerHTML = `Estimated: <strong>${out.toLocaleString(undefined,{maximumFractionDigits:6})} ${selectedTo.symbol}</strong>${usd?(' • ~$'+(out*(usd)).toFixed(2)) : ''}`;
    swapBtn.disabled = false;
  }catch(e){
    console.error(e);
    quoteText.textContent = 'Quote failed. Try again.';
    swapBtn.disabled = true;
  }
});

/* ================ Wallet connection (MetaMask + WalletConnect v2 via Web3Modal) ================ */
let web3modalInstance = null;
let wcProvider = null;

async function initWeb3Modal(){
  try{
    const client = new window.WalletConnectWeb3Modal.default({
      projectId: WALLETCONNECT_PROJECT_ID,
      themeMode: 'dark'
    });
    web3modalInstance = client;
  }catch(e){
    console.warn('Web3Modal init failed', e);
  }
}
initWeb3Modal();

async function connectWallet(){
  // MetaMask preferred
  if(window.ethereum && window.ethereum.isMetaMask){
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    addrChip.style.display = 'inline-block';
    addrChip.textContent = userAddress.slice(0,6)+'…'+userAddress.slice(-4);
    return true;
  }
  // fallback to WalletConnect modal (requires project id)
  if(web3modalInstance && WALLETCONNECT_PROJECT_ID && WALLETCONNECT_PROJECT_ID !== 'WALLETCONNECT_PROJECT_ID'){
    try{
      wcProvider = await web3modalInstance.openModal(); // opens modal/QR/links
      provider = new ethers.providers.Web3Provider(wcProvider);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      addrChip.style.display = 'inline-block';
      addrChip.textContent = userAddress.slice(0,6)+'…'+userAddress.slice(-4);
      return true;
    }catch(err){
      console.error('WalletConnect connect failed', err);
      return false;
    }
  }
  alert('No wallet found. Install MetaMask or set WalletConnect project ID in code.');
  return false;
}

connectWalletFloating.addEventListener('click', connectWallet);

/* ================ Swap execution (1inch swap endpoint) ================ */
swapBtn.addEventListener('click', async ()=>{
  if(!provider || !signer){
    const ok = confirm('You need to connect wallet to swap. Connect now?');
    if(!ok) return;
    const ok2 = await connectWallet();
    if(!ok2) return;
  }
  if(!selectedFrom || !selectedTo) return alert('Select tokens first');
  const amount = (fromAmount.value||'').trim();
  if(!amount) return alert('Enter amount');
  try{
    const amountInt = toBigIntAmount(amount, selectedFrom.decimals || 18).toString();
    const swapUrl = `${ONEINCH_BASE}/swap?fromTokenAddress=${selectedFrom.address}&toTokenAddress=${selectedTo.address}&amount=${amountInt}&fromAddress=${userAddress}&slippage=1`;
    const res = await fetch(swapUrl);
    const data = await res.json();
    if(!data.tx) throw new Error('swap build failed');
    const txParams = data.tx;
    const tx = await signer.sendTransaction({
      to: txParams.to,
      data: txParams.data,
      value: txParams.value ? txParams.value : undefined
    });
    alert('Swap tx sent: ' + tx.hash);
  }catch(e){
    console.error(e);
    alert('Swap failed: ' + (e.message || e));
  }
});

/* ================= Chat (Gun.js) global peers + themed modal ================= */
const gun = Gun({ peers: GUN_PEERS });
const chatNode = gun.get('nola_exchange_global_chat_v1');
let chatUser = null;
const userColors = {};
function pickColor(name){ if(userColors[name]) return userColors[name]; const c = '#'+Math.floor(Math.random()*16777215).toString(16); userColors[name]=c; return c; }

sendChatBtn.addEventListener('click', ()=>{
  const txt = (chatInput.value||'').trim();
  if(!txt) return;
  if(!chatUser){
    usernameModal.style.display = 'flex';
    return;
  }
  const item = { user: chatUser, text: txt, color: pickColor(chatUser), t: Date.now() };
  chatNode.set(item);
  chatInput.value = '';
});

confirmName.addEventListener('click', ()=>{
  const v = (modalName.value||'').trim();
  chatUser = v || ('Anon'+Math.floor(Math.random()*999));
  usernameModal.style.display = 'none';
});

cancelName.addEventListener('click', ()=>{ usernameModal.style.display='none'; });

// listen to chat
chatNode.map().on(m=>{
  if(!m || !m.user || !m.text) return;
  const el = document.createElement('div'); el.className='chat-msg';
  el.style.background = (m.color || '#8a2be233');
  el.innerHTML = `<div class="chat-who" style="color:${m.color||'#fff'}">${escapeHtml(m.user)}</div><div>${escapeHtml(m.text)}</div>`;
  chatMessages.appendChild(el);
  chatMessages.scrollTop = chatMessages.scrollHeight;
});

/* ===== Helper ===== */
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ===== On load, open NOLA token chart immediately ===== */
openChart(INITIAL_NOLA_TOKEN);

</script>
</body>
</html>
