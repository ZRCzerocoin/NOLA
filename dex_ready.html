<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NOLA Exchange</title>
<style>
/* ===== RESET ===== */
* {margin:0; padding:0; box-sizing:border-box; font-family:'Arial',sans-serif;}
body {overflow-x:hidden; background: radial-gradient(circle at center, #0c0014, #1a002b 80%); color:#fff; scroll-behavior:smooth;}

/* ===== PARTICLES ===== */
body::before { content:''; position:fixed; width:200%; height:200%; background: radial-gradient(circle, rgba(150,0,255,0.2), transparent 60%); animation: nebulaMove 20s infinite alternate ease-in-out; z-index:-2;}
@keyframes nebulaMove {0% {transform: translate(-10%,-10%);} 100% {transform: translate(5%,5%);} }
.particle { position:absolute; width:2px; height:2px; background:#b445ff; border-radius:50%; opacity:0.8; animation: floatParticle linear infinite;}
@keyframes floatParticle {0%{transform:translateY(0) translateX(0);opacity:0.8;}50%{transform:translateY(-50px) translateX(20px);opacity:0.4;}100%{transform:translateY(0) translateX(0);opacity:0.8;}}

/* ===== LOGO ===== */
.logo { width:150px; display:block; margin:25px auto; animation: logoGlow 5s ease-in-out infinite alternate, logoRotate 30s linear infinite;}
@keyframes logoGlow {0%{filter:drop-shadow(0 0 15px #9c00ff);}50%{filter:drop-shadow(0 0 35px #d15fff);}100%{filter:drop-shadow(0 0 15px #9c00ff);}}
@keyframes logoRotate {0%{transform:rotateY(0deg);}100%{transform:rotateY(360deg);}}

/* ===== CARD ===== */
.container { width:90%; max-width:480px; margin:40px auto; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:25px; padding:25px; backdrop-filter:blur(18px); box-shadow:0 0 25px rgba(180,0,255,0.3); animation:cardIn 1s ease; perspective:1000px;}
@keyframes cardIn {from{opacity:0; transform:translateY(30px);}to{opacity:1; transform:translateY(0);}}
h2{text-align:center; font-size:28px; font-weight:600; margin-bottom:15px; color:#e0b3ff; text-shadow:0 0 8px #b445ff;}

/* ===== INPUT ===== */
.input-box { margin-top:20px; padding:15px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:16px; box-shadow:0 0 15px rgba(150,0,255,0.15); transition:0.3s; position:relative; }
.input-box:hover{box-shadow:0 0 30px rgba(180,0,255,0.35); transform:translateY(-3px);}
.input-box input{width:100%; padding:12px; border-radius:12px; border:none; background:rgba(255,255,255,0.05); color:#fff; font-size:16px;}
.input-box p{font-size:14px; opacity:0.8; margin-bottom:8px;}

/* small usd displays under inputs */
.usd-line { margin-top:8px; font-size:13px; color:rgba(255,255,255,0.8); }

/* ===== TOKEN SUGGESTIONS ===== */
.suggestions { position:absolute; top:65px; left:0; width:100%; background:rgba(25,0,50,0.95); border-radius:12px; max-height:260px; overflow-y:auto; display:none; z-index:100; }
.suggestion-item { padding:10px; display:flex; align-items:center; cursor:pointer; transition:0.2s; justify-content:space-between; }
.suggestion-item:hover { background:rgba(120,0,255,0.3); }
.suggestion-item img { width:28px; height:28px; margin-right:10px; border-radius:12px; }

/* ===== BUTTON ===== */
.btn { width:100%; padding:14px; margin-top:20px; border:none; border-radius:20px; background: linear-gradient(135deg,#b445ff,#7013ff); color:#fff; font-size:18px; cursor:pointer; box-shadow:0 0 15px rgba(180,0,255,0.35); transition:0.3s; position:relative; overflow:hidden;}
.btn::after { content:''; position:absolute; left:50%; top:50%; width:300%; height:300%; background:rgba(255,255,255,0.1); transform:translate(-50%,-50%) scale(0); border-radius:50%; transition:0.5s; }
.btn:hover::after { transform:translate(-50%,-50%) scale(1); }
.btn:hover { transform:scale(1.05); box-shadow:0 0 25px rgba(200,0,255,0.55); }
.btn.small { width:auto; padding:10px 12px; border-radius:12px; font-size:14px; }

/* ===== CHAT SIDEBAR ===== */
.chat-toggle { position:fixed; right:20px; bottom:20px; background:#b445ff; padding:10px 14px; border-radius:20px; cursor:pointer; box-shadow:0 0 15px rgba(180,0,255,0.35); }
.chat-sidebar { position:fixed; right:20px; bottom:60px; width:320px; max-height:500px; background:rgba(0,0,0,0.3); backdrop-filter:blur(10px); border-radius:20px; padding:15px; overflow-y:auto; display:none; flex-direction:column;}
.chat-msg { margin-bottom:10px; padding:8px; border-radius:12px; font-size:14px; word-break:break-word; }
.chat-input { display:flex; margin-top:10px; }
.chat-input input{flex:1; padding:8px 10px; border-radius:12px; border:none; background:rgba(255,255,255,0.05); color:#fff;}
.chat-input button{margin-left:5px; padding:8px 12px; border-radius:12px; border:none; background:#b445ff; cursor:pointer;}

/* ===== USERNAME MODAL ===== */
#usernameModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:2000; }
#usernameModal .modal-content { background:rgba(255,255,255,0.05); padding:25px; border-radius:20px; text-align:center; backdrop-filter:blur(15px); animation:modalIn 0.5s ease; }
#usernameModal input{padding:10px 12px; border-radius:12px; border:none; width:80%; margin-top:15px; background:rgba(255,255,255,0.05); color:#fff;}
#usernameModal button{margin-top:15px; padding:10px 20px; border:none; border-radius:12px; background:linear-gradient(135deg,#b445ff,#7013ff); color:#fff; cursor:pointer;}
@keyframes modalIn {from{opacity:0; transform:scale(0.8);}to{opacity:1; transform:scale(1);}}

/* chart area (tucked under container) */
.chart-wrap { width:90%; max-width:480px; margin:12px auto 20px; height:400px; border-radius:14px; overflow:hidden; border:1px solid rgba(255,255,255,0.03); display:none; }
.chart-wrap iframe{width:100%; height:100%; border:0; background:#08020b}

/* top-right floating connect (keeps theme) */
.top-right-connect { position:fixed; right:18px; top:18px; z-index:60; display:flex; gap:10px; align-items:center; }
.addr-chip { padding:8px 12px; border-radius:12px; background:rgba(255,255,255,0.03); font-weight:700; display:none }
.connect-floating { background:linear-gradient(90deg,#b445ff,#7013ff); color:#fff; padding:10px 14px; border-radius:12px; border:none; cursor:pointer; font-weight:800; box-shadow:0 10px 30px rgba(106,0,255,0.12); }

/* Footer */
.footer { margin:30px auto 40px; width:90%; max-width:980px; color:rgba(255,255,255,0.7); display:flex; justify-content:space-between; align-items:center; font-size:14px; gap:10px; }
.footer .links { display:flex; gap:12px; align-items:center; }
.footer a { color:rgba(215,165,255,0.95); text-decoration:none; font-weight:600; }
.footer .right { opacity:0.8; }

@media(max-width:560px){
  .container { padding:18px; }
  .footer { flex-direction:column; gap:8px; text-align:center; }
}
</style>
</head>
<body>

<!-- PARTICLES -->
<script>
for(let i=0;i<60;i++){
    let particle=document.createElement('div');
    particle.className='particle';
    particle.style.top=Math.random()*100+'%';
    particle.style.left=Math.random()*100+'%';
    particle.style.width=(Math.random()*3+1)+'px';
    particle.style.height=(Math.random()*3+1)+'px';
    particle.style.animationDuration=(Math.random()*10+5)+'s';
    document.body.appendChild(particle);
}
</script>

<!-- LOGO -->
<img src="nol.png" class="logo" alt="NOLA logo">

<!-- TOP-RIGHT CONNECT -->
<div class="top-right-connect">
  <div id="addrChip" class="addr-chip"></div>
  <button id="connectFloating" class="connect-floating">Connect Wallet</button>
</div>

<!-- MAIN CARD (exact theme preserved) -->
<div class="container">
    <h2>NOLA Exchange</h2>

    <div class="input-box">
        <p>From Token</p>
        <input type="text" id="fromToken" placeholder="Type token name...">
        <div class="suggestions" id="fromSuggestions"></div>
        <div class="usd-line" id="fromUsd"></div>

        <!-- Amount input (small, themed) -->
        <div style="margin-top:10px;">
          <input id="amountInput" placeholder="Amount (e.g. 1.5)" style="width:100%; padding:10px; border-radius:10px; border:none; background:rgba(255,255,255,0.03); color:#fff;">
        </div>
    </div>

    <div class="input-box">
        <p>To Token</p>
        <input type="text" id="toToken" placeholder="Type token name...">
        <div class="suggestions" id="toSuggestions"></div>
        <div class="usd-line" id="toUsd"></div>
    </div>

    <div style="display:flex;gap:10px; align-items:center; margin-top:10px;">
      <button class="btn small" id="swapBtn" style="flex:1">Swap</button>
    </div>
</div>

<!-- Chart (under the same theme) -->
<div class="chart-wrap" id="chartWrap">
  <iframe id="chartFrame" src="" allowfullscreen></iframe>
</div>

<!-- CHAT TOGGLE -->
<div class="chat-toggle" id="chatToggle">ðŸ’¬ Chat</div>

<!-- CHAT SIDEBAR -->
<div class="chat-sidebar" id="chatSidebar">
    <h3 style="text-align:center;">Public Chat</h3>
    <div id="chatMessages" style="flex:1; overflow-y:auto;"></div>
    <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Type message...">
        <button id="sendChat">Send</button>
    </div>
</div>

<!-- USERNAME MODAL -->
<div id="usernameModal">
    <div class="modal-content">
        <h3>Choose Your NOLA Username ðŸŒŒ</h3>
        <input type="text" id="modalUsername" placeholder="Type your username">
        <button id="confirmUsername">Enter Chat</button>
    </div>
</div>

<!-- FOOTER -->
<div class="footer">
  <div class="links">
    <a href="Terms.html" id="termsLink">Terms</a>
    <a href="#" id="privacyLink">Privacy</a>
    <a href="#" id="nolaSiteLink">NOLA Token</a>
    <a href="#" id="xLink">X</a>
    <a href="#" id="telegramLink">Telegram</a>
  </div>
  <div class="right">Â© NOLA â€” All rights reserved</div>
</div>

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://unpkg.com/@web3modal/html@2.1.1/dist/index.js"></script>
<script src="https://unpkg.com/@walletconnect/web3modal@2.6.4/dist/w3m.min.js"></script>

<script>
/* ================== CONFIG ================== */
const CHAIN_ID = 137;
const ONEINCH_BASE = `https://api.1inch.io/v5.0/${CHAIN_ID}`;
const COINGECKO = (addr)=>`https://api.coingecko.com/api/v3/simple/token_price/polygon-pos?contract_addresses=${addr}&vs_currencies=usd`;
const WALLETCONNECT_PROJECT_ID = "WALLETCONNECT_PROJECT_ID"; // <-- paste your WalletConnect v2 Project ID here
const GUN_PEERS = [
  'https://relay.peer.ooo/gun',
  'https://gun-us.herokuapp.com/gun',
  'https://gun-manhattan.herokuapp.com/gun'
];
const INITIAL_NOLA_TOKEN = '0x1515546B052151D5eb8CCB1bcf2857E0C6f51451'.toLowerCase();

/* ================== DOM refs ================== */
const fromTokenInput = document.getElementById('fromToken');
const toTokenInput = document.getElementById('toToken');
const fromSuggest = document.getElementById('fromSuggestions');
const toSuggest = document.getElementById('toSuggestions');
const fromUsdLine = document.getElementById('fromUsd');
const toUsdLine = document.getElementById('toUsd');
const amountInput = document.getElementById('amountInput');
const swapBtn = document.getElementById('swapBtn');
const chartWrap = document.getElementById('chartWrap');
const chartFrame = document.getElementById('chartFrame');
const connectFloating = document.getElementById('connectFloating');
const addrChip = document.getElementById('addrChip');

const chatToggle = document.getElementById('chatToggle');
const chatSidebar = document.getElementById('chatSidebar');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChat');
const usernameModal = document.getElementById('usernameModal');
const modalUsername = document.getElementById('modalUsername');
const confirmUsername = document.getElementById('confirmUsername');

/* ================== STATE ================== */
let tokenList = [];
let selectedFrom = null;
let selectedTo = null;
let provider = null, signer = null, userAddress = null;
let web3modal = null;

/* ================== UTIL ================== */
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
function short(a){ return a ? a.slice(0,6)+'â€¦'+a.slice(-4) : ''; }
async function fetchJson(url, opts){ const r = await fetch(url, opts); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

/* ================== LOAD TOKENS (1inch) - then attach autocomplete ================== */
async function loadTokens(){
  try{
    const d = await fetchJson(`${ONEINCH_BASE}/tokens`);
    tokenList = Object.values(d.tokens || {});
    tokenList.forEach(t=> t.address = (t.address||'').toLowerCase());
    console.log('1inch tokens loaded', tokenList.length);
    attachAutocomplete(); // attach after tokens loaded to avoid race
  }catch(e){ console.error('token load failed', e); attachAutocomplete(); }
}
loadTokens();

/* ================== USD price ================== */
async function fetchUsd(address){
  try{
    const a = (address||'').toLowerCase();
    if(!a) return null;
    const r = await fetch(COINGECKO(a));
    if(!r.ok) return null;
    const j = await r.json();
    return j[a]?.usd ?? null;
  }catch(e){ return null; }
}

/* ================== AUTOCOMPLETE (attached after tokenList loaded) ================== */
function createSuggestionItem(token){
  const div = document.createElement('div');
  div.className = 'suggestion-item';
  div.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><img src="${token.logoURI||''}" onerror="this.style.display='none'"><div style="display:flex;flex-direction:column"><strong style="font-weight:800">${escapeHtml(token.symbol)}</strong><span style="font-size:12px;color:rgba(255,255,255,0.75)">${escapeHtml(token.name)}</span></div></div>`;
  return div;
}

function attachAutocomplete(){
  // Both inputs: on input, build list from tokenList
  function bind(inputEl, suggestEl, onSelect){
    inputEl.addEventListener('input', async ()=>{
      const q = (inputEl.value||'').trim().toLowerCase();
      suggestEl.innerHTML = '';
      if(!q){ suggestEl.style.display = 'none'; return; }
      const bySym = tokenList.filter(t => (t.symbol||'').toLowerCase().includes(q));
      const byName = tokenList.filter(t => (t.name||'').toLowerCase().includes(q) && !bySym.includes(t));
      const res = [...bySym, ...byName].slice(0,8);
      for(const tok of res){
        const item = createSuggestionItem(tok);
        // price badge
        (async ()=>{
          try{
            const usd = await fetchUsd(tok.address);
            if(usd !== null){
              const price = document.createElement('div');
              price.style.marginLeft = 'auto';
              price.style.fontWeight = '800';
              price.style.fontSize = '13px';
              price.textContent = '$' + Number(usd).toFixed(4);
              item.appendChild(price);
            }
          }catch(e){}
        })();
        item.onclick = ()=>{ inputEl.value = tok.symbol; suggestEl.style.display = 'none'; onSelect(tok); };
        suggestEl.appendChild(item);
      }
      suggestEl.style.display = res.length ? 'block' : 'none';
    });

    inputEl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        const q = (inputEl.value||'').trim().toLowerCase();
        if(!q) return;
        const found = tokenList.find(t => ((t.symbol||'').toLowerCase() === q) || ((t.name||'').toLowerCase() === q) || ((t.address||'').toLowerCase() === q));
        if(found){ inputEl.value = found.symbol; suggestEl.style.display='none'; onSelect(found); return; }
        const fuzzy = tokenList.find(t => (t.symbol||'').toLowerCase().includes(q) || (t.name||'').toLowerCase().includes(q));
        if(fuzzy){ inputEl.value = fuzzy.symbol; suggestEl.style.display='none'; onSelect(fuzzy); return; }
        suggestEl.style.display='none';
      }
    });
  }

  bind(fromTokenInput, fromSuggest, async (tok)=>{
    selectedFrom = tok;
    const usd = await fetchUsd(tok.address);
    fromUsdLine.textContent = usd ? `${tok.symbol} â‰ˆ $${Number(usd).toFixed(6)}` : `${tok.symbol} price unknown`;
    // when selecting from, open chart for that token
    openChart(tok.address);
  });

  bind(toTokenInput, toSuggest, async (tok)=>{
    selectedTo = tok;
    const usd = await fetchUsd(tok.address);
    toUsdLine.textContent = usd ? `${tok.symbol} â‰ˆ $${Number(usd).toFixed(6)}` : `${tok.symbol} price unknown`;
    openChart(tok.address);
  });
}

/* ================== Chart (Gecko first, Dexscreener fallback) ================== */
function openChart(address){
  if(!address) return;
  const a = address.toLowerCase();
  const gecko = `https://www.geckoterminal.com/polygon/tokens/${a}?embed=1`;
  const dexs = `https://www.dexscreener.com/polygon/${a}?embed=1`;
  chartFrame.src = gecko;
  chartWrap.style.display = 'block';
  let fallback = setTimeout(()=>{ chartFrame.src = dexs; }, 3800);
  const onload = ()=>{ clearTimeout(fallback); cleanup(); };
  const onerror = ()=>{ clearTimeout(fallback); chartFrame.src = dexs; cleanup(); };
  function cleanup(){ try{ chartFrame.removeEventListener('load', onload); chartFrame.removeEventListener('error', onerror); }catch(e){} }
  chartFrame.addEventListener('load', onload);
  chartFrame.addEventListener('error', onerror);
}
// show NOLA token chart on load
openChart(INITIAL_NOLA_TOKEN);

/* ================== Web3Modal (WalletConnect v2) init ================== */
async function initWeb3Modal(){
  try{
    web3modal = new window.WalletConnectWeb3Modal.default({
      projectId: WALLETCONNECT_PROJECT_ID,
      themeMode: 'dark'
    });
  }catch(e){ console.warn('web3modal init failed', e); web3modal = null; }
}
initWeb3Modal();

/* ================== Connect wallet (MetaMask pref, WalletConnect fallback) ================== */
async function connectWallet(){
  try{
    if(window.ethereum && window.ethereum.isMetaMask){
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send('eth_requestAccounts', []);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      addrChip.style.display = 'inline-block';
      addrChip.textContent = short(userAddress);
      return true;
    }
    if(web3modal && WALLETCONNECT_PROJECT_ID && WALLETCONNECT_PROJECT_ID !== 'WALLETCONNECT_PROJECT_ID'){
      const wcProvider = await web3modal.openModal();
      if(!wcProvider) return false;
      provider = new ethers.providers.Web3Provider(wcProvider);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      addrChip.style.display = 'inline-block';
      addrChip.textContent = short(userAddress);
      return true;
    }
    alert('No wallet found. Install MetaMask or set WalletConnect Project ID in the code.');
    return false;
  }catch(e){
    console.error('connect wallet error', e);
    alert('Wallet connection failed: ' + (e.message || e));
    return false;
  }
}
connectFloating.addEventListener('click', connectWallet);

/* ================== utils for amounts ================== */
function toBigIntAmount(value, decimals=18){
  const parts = String(value).split('.');
  if(parts.length === 1) return BigInt(parts[0] || '0') * (BigInt(10) ** BigInt(decimals));
  const intPart = parts[0] || '0';
  const decPart = (parts[1] || '').slice(0,decimals).padEnd(decimals,'0');
  return BigInt(intPart) * (BigInt(10) ** BigInt(decimals)) + BigInt(decPart);
}

/* ================== SINGLE-SWAP FLOW: quote -> approval -> swap ================== */
swapBtn.addEventListener('click', async ()=>{
  try{
    if(!selectedFrom || !selectedTo) return alert('Choose both From and To tokens first.');
    const amount = (amountInput.value||'').trim();
    if(!amount || isNaN(Number(amount))) return alert('Enter a valid amount.');
    // ensure wallet connected
    if(!provider || !signer){
      const ok = confirm('Connect wallet to swap now?');
      if(!ok) return;
      const ok2 = await connectWallet();
      if(!ok2) return;
    }
    // build quote
    const amountInt = toBigIntAmount(amount, selectedFrom.decimals || 18).toString();
    swapBtn.disabled = true; swapBtn.textContent = 'Preparing...';
    const quoteUrl = `${ONEINCH_BASE}/quote?fromTokenAddress=${selectedFrom.address}&toTokenAddress=${selectedTo.address}&amount=${amountInt}`;
    const qRes = await fetch(quoteUrl);
    if(!qRes.ok) throw new Error('Quote failed');
    const qJson = await qRes.json();
    const outAmount = Number(qJson.toTokenAmount) / (10 ** (selectedTo.decimals || 18));
    // allowance check & approve if needed (skip if native)
    const nativeAddr = '0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee'; // 1inch pseudo-native
    const fromAddr = (selectedFrom.address||'').toLowerCase();
    if(fromAddr !== nativeAddr){
      // check allowance
      const allowUrl = `${ONEINCH_BASE}/approve/allowance?tokenAddress=${fromAddr}&walletAddress=${userAddress}`;
      const allowRes = await fetch(allowUrl);
      const allowJson = await allowRes.json();
      const allowance = BigInt(allowJson.allowance || '0');
      const want = BigInt(amountInt);
      if(allowance < want){
        // build approve tx
        const approveUrl = `${ONEINCH_BASE}/approve/transaction?tokenAddress=${fromAddr}`;
        const approveRes = await fetch(approveUrl);
        const approveTx = await approveRes.json();
        if(!approveTx || !approveTx.data) throw new Error('Approve build failed');
        swapBtn.textContent = 'Approving...';
        // send approval
        const sent = await signer.sendTransaction({ to: approveTx.to, data: approveTx.data, value: approveTx.value ? approveTx.value : undefined });
        alert('Approve tx sent: ' + sent.hash);
        await sent.wait();
        alert('Approval confirmed â€” proceeding to swap');
      }
    }
    // build swap
    swapBtn.textContent = 'Swapping ...';
    const swapUrl = `${ONEINCH_BASE}/swap?fromTokenAddress=${selectedFrom.address}&toTokenAddress=${selectedTo.address}&amount=${amountInt}&fromAddress=${userAddress}&slippage=1`;
    const swapRes = await fetch(swapUrl);
    const swapJson = await swapRes.json();
    if(!swapJson || !swapJson.tx) throw new Error('Swap build failed: ' + JSON.stringify(swapJson));
    // send tx
    const txParams = swapJson.tx;
    const tx = await signer.sendTransaction({
      to: txParams.to,
      data: txParams.data,
      value: txParams.value ? txParams.value : undefined
    });
    alert('Swap tx sent: ' + tx.hash);
    swapBtn.textContent = 'Swap';
    swapBtn.disabled = false;
  }catch(e){
    console.error('swap flow error', e);
    alert('Swap failed: ' + (e.message || e));
    swapBtn.textContent = 'Swap';
    swapBtn.disabled = false;
  }
});

/* ================== Chat (Gun) with global peers & themed modal ================== */
const gun = Gun({ peers: GUN_PEERS });
const chatNode = gun.get('nola_chat_global_v1');
let chatUser = null;
const userColors = {};
function pickColor(n){ if(userColors[n]) return userColors[n]; const c = '#'+Math.floor(Math.random()*16777215).toString(16); userColors[n]=c; return c; }

sendChatBtn.addEventListener('click', ()=>{
  const txt = (chatInput.value||'').trim();
  if(!txt) return;
  if(!chatUser){ usernameModal.style.display='flex'; return; }
  const obj = { user: chatUser, text: txt, color: pickColor(chatUser), t: Date.now() };
  chatNode.set(obj);
  chatInput.value = '';
});

confirmUsername.addEventListener('click', ()=>{
  const v = (modalUsername.value||'').trim();
  chatUser = v || ('Anon'+Math.floor(Math.random()*999));
  usernameModal.style.display = 'none';
});

chatNode.map().on(m=>{
  if(!m || !m.user || !m.text) return;
  const el = document.createElement('div');
  el.className = 'chat-msg';
  el.style.background = (m.color || '#8a2be233');
  el.innerHTML = `<b style="color:${m.color||'#fff'}">${escapeHtml(m.user)}</b><div style="margin-top:6px">${escapeHtml(m.text)}</div>`;
  chatMessages.appendChild(el);
  chatMessages.scrollTop = chatMessages.scrollHeight;
});

chatToggle.addEventListener('click', ()=> {
  chatSidebar.style.display = (chatSidebar.style.display === 'flex') ? 'none' : 'flex';
});

/* ================== final logs ================== */
setTimeout(()=>{ if(tokenList.length) console.log('Tokens loaded:', tokenList.length) }, 1200);

</script>
</body>
</html>
